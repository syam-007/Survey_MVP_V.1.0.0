# Story 4.6: Survey Calculation Frontend Integration

## Status
In Progress

## Story
**As a** survey engineer,
**I want** a seamless frontend workflow from file upload to viewing results,
**so that** I can efficiently process survey data end-to-end

## Acceptance Criteria
1. **File Upload Component** - Create React component for drag-and-drop file upload
2. **Upload Progress Indicator** - Show upload progress bar
3. **Validation Feedback** - Display validation errors clearly to user
4. **Processing Status** - Show real-time calculation status (uploading → validating → calculating → interpolating → complete)
5. **Results Page** - Create survey results page showing:
   - File metadata (name, upload time, row count)
   - Calculation summary (status, duration, data points)
   - 2D and 3D plots
   - Download buttons
6. **Navigation** - Add survey upload option to run detail page
7. **Multiple File Support** - Track and display multiple survey files per run
8. **Error Display** - User-friendly error messages for failed uploads/calculations
9. **Success Notifications** - Confirm successful completion with notification
10. **Loading States** - Proper loading indicators throughout workflow
11. **Responsive Design** - Mobile-friendly file upload and results display
12. **Unit Tests** - Test upload flow, status updates, error handling (>80% coverage)
13. **Integration Tests** - Test complete workflow from upload to visualization

## Tasks / Subtasks

- [x] **Task 1: Create File Upload Component** (AC: 1, 2, 11)
  - [x] Install react-dropzone library
  - [x] Create `apps/web/src/components/survey/SurveyFileUpload.tsx`
  - [x] Implement drag-and-drop zone
  - [x] Add file type validation (.xlsx, .csv)
  - [x] Add file size validation (max 50MB)
  - [x] Implement upload progress bar with percentage
  - [x] Add file preview (name, size) before upload
  - [x] Make responsive for mobile devices

- [x] **Task 2: Create Upload API Integration** (AC: 2, 3, 8)
  - [x] Add upload method to `apps/web/src/services/surveysService.ts`
  - [x] Implement multipart/form-data upload
  - [x] Track upload progress with XMLHttpRequest
  - [x] Handle upload errors with specific messages
  - [x] Parse validation errors from API response
  - [x] Return upload result with survey_data_id

- [x] **Task 3: Implement Processing Status Tracking** (AC: 4, 10)
  - [x] Create `apps/web/src/components/survey/ProcessingStatus.tsx`
  - [x] Implement status polling mechanism (every 2 seconds)
  - [x] Display status stages: uploading → validating → calculating → interpolating → complete
  - [x] Add progress indicators for each stage
  - [x] Implement status API endpoint polling
  - [x] Handle status transitions with animations
  - [x] Stop polling when complete or error

- [x] **Task 4: Create Survey Results Page** (AC: 5, 7)
  - [x] Create `apps/web/src/pages/runs/SurveyResultsPage.tsx`
  - [x] Implement route `/runs/:runId/surveys/:surveyDataId`
  - [x] Display file metadata section (filename, upload date, row count)
  - [x] Display calculation summary (status, duration, data point counts)
  - [x] Integrate Plot2D and Plot3D components from Story 4.4
  - [x] Integrate DownloadButton component (created in this story)
  - [x] Add data source toggle for calculated/interpolated
  - [x] Create responsive grid layout
  - [x] Add navigation breadcrumbs

- [x] **Task 5: Add Upload Option to Run Detail Page** (AC: 6)
  - [x] Update `apps/web/src/pages/runs/RunDetailPage.tsx`
  - [x] Add "Upload Survey File" button
  - [x] Create upload modal/dialog
  - [x] Include survey type selector in upload form
  - [x] Redirect to results page after successful upload

- [x] **Task 6: Implement Multiple File Support** (AC: 7)
  - [x] Create `apps/web/src/components/survey/SurveyFileList.tsx`
  - [x] Display all survey files for a run
  - [x] Show status badge for each file (complete, processing, error)
  - [x] Add click to view results
  - [x] Show upload date and file size
  - [x] Add delete file option (with confirmation)

- [x] **Task 7: Error Handling and Notifications** (AC: 3, 8, 9)
  - [x] Create `apps/web/src/components/common/ErrorDisplay.tsx`
  - [x] Display validation errors in user-friendly format
  - [x] Show error alerts for upload failures
  - [x] Show error alerts for calculation failures
  - [x] Implement success snackbar for completed processing
  - [x] Add retry button for failed operations
  - [x] Log errors to console for debugging

- [x] **Task 8: State Management** (AC: 4, 10)
  - [x] Create React Query hooks for survey operations
  - [x] Create `apps/web/src/hooks/useSurveyUpload.ts`
  - [x] Create `apps/web/src/hooks/useSurveyStatus.ts`
  - [x] Implement caching for survey data
  - [x] Handle optimistic updates
  - [x] Implement retry logic for failed requests

- [ ] **Task 9: Write Unit Tests** (AC: 12)
  - [ ] Create `apps/web/src/components/survey/__tests__/SurveyFileUpload.test.tsx`
  - [ ] Test file drop, validation, upload progress
  - [ ] Create `apps/web/src/components/survey/__tests__/ProcessingStatus.test.tsx`
  - [ ] Test status transitions, polling
  - [ ] Create `apps/web/src/pages/runs/__tests__/SurveyResultsPage.test.tsx`
  - [ ] Test results page rendering, data display
  - [ ] Ensure >80% code coverage

- [ ] **Task 10: Write Integration Tests** (AC: 13)
  - [ ] Create `apps/web/cypress/e2e/survey-workflow.cy.ts`
  - [ ] Test complete workflow: upload → validate → calculate → visualize
  - [ ] Test error scenarios (invalid file, missing columns)
  - [ ] Test download functionality
  - [ ] Test multiple file uploads
  - [ ] Verify end-to-end flow completes successfully

## Dev Notes

### Story 4.5 Context (Previous Work - Download)

**DownloadButton Component** [Source: Story 4.5]
- `apps/web/src/components/survey/DownloadButton.tsx` - Download button with format selection
- Supports downloading calculated and interpolated surveys in Excel and CSV formats

**Story 4.4 Context (Previous Work - Visualization)**
- `apps/web/src/components/visualization/Plot2D.tsx` - 2D plot component
- `apps/web/src/components/visualization/Plot3D.tsx` - 3D plot component
- `apps/web/src/components/visualization/DataSourceToggle.tsx` - Toggle between calculated/interpolated

### Frontend Integration Overview

This story implements the complete end-to-end frontend workflow for survey file processing. Users will upload files via drag-and-drop, monitor processing status in real-time, and view results with visualizations.

**Key Features:**
1. **Intuitive drag-and-drop file upload** with validation feedback
2. **Real-time status tracking** showing each processing stage
3. **Comprehensive results page** with metadata, plots, and download options
4. **Multiple file management** for runs with multiple surveys
5. **Responsive design** working on mobile, tablet, and desktop

### React Dropzone Integration

**Installation:**
```bash
npm install react-dropzone
```

**Basic Usage:**
```typescript
import { useDropzone } from 'react-dropzone';

const { getRootProps, getInputProps, isDragActive } = useDropzone({
  accept: {
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'],
    'text/csv': ['.csv']
  },
  maxSize: 50 * 1024 * 1024,  // 50MB
  onDrop: handleFileDrop
});
```

### File Upload Component Specification

**File Location:** `apps/web/src/components/survey/SurveyFileUpload.tsx`

**Component Pattern:**
```typescript
import React, { useState, useCallback } from 'react';
import { useDropzone } from 'react-dropzone';
import {
  Box,
  Paper,
  Typography,
  Button,
  LinearProgress,
  Alert,
  FormControl,
  InputLabel,
  Select,
  MenuItem
} from '@mui/material';
import CloudUploadIcon from '@mui/icons-material/CloudUpload';
import { useSurveyUpload } from '../../hooks/useSurveyUpload';

interface SurveyFileUploadProps {
  runId: string;
  onUploadComplete: (surveyDataId: string) => void;
  onUploadError: (error: string) => void;
}

export const SurveyFileUpload: React.FC<SurveyFileUploadProps> = ({
  runId,
  onUploadComplete,
  onUploadError
}) => {
  const [selectedFile, setSelectedFile] = useState<File | null>(null);
  const [surveyType, setSurveyType] = useState<string>('Type 2 - Gyro');
  const [uploadProgress, setUploadProgress] = useState<number>(0);

  const { uploadSurvey, isUploading, error } = useSurveyUpload();

  const onDrop = useCallback((acceptedFiles: File[]) => {
    if (acceptedFiles.length > 0) {
      setSelectedFile(acceptedFiles[0]);
    }
  }, []);

  const { getRootProps, getInputProps, isDragActive, fileRejections } = useDropzone({
    onDrop,
    accept: {
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'],
      'text/csv': ['.csv']
    },
    maxSize: 50 * 1024 * 1024,  // 50MB
    maxFiles: 1
  });

  const handleUpload = async () => {
    if (!selectedFile) return;

    try {
      const result = await uploadSurvey({
        file: selectedFile,
        runId,
        surveyType,
        onProgress: (progress) => setUploadProgress(progress)
      });

      onUploadComplete(result.surveyDataId);
    } catch (err: any) {
      onUploadError(err.message || 'Upload failed');
    }
  };

  const formatFileSize = (bytes: number): string => {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  };

  return (
    <Box sx={{ width: '100%', maxWidth: 600, mx: 'auto', mt: 4 }}>
      {/* Survey Type Selector */}
      <FormControl fullWidth sx={{ mb: 3 }}>
        <InputLabel>Survey Type</InputLabel>
        <Select
          value={surveyType}
          onChange={(e) => setSurveyType(e.target.value)}
          disabled={isUploading}
        >
          <MenuItem value="Type 1 - GTL">Type 1 - GTL</MenuItem>
          <MenuItem value="Type 2 - Gyro">Type 2 - Gyro</MenuItem>
          <MenuItem value="Type 3 - MWD">Type 3 - MWD</MenuItem>
          <MenuItem value="Type 4 - Unknown">Type 4 - Unknown</MenuItem>
        </Select>
      </FormControl>

      {/* Dropzone */}
      <Paper
        {...getRootProps()}
        sx={{
          p: 4,
          textAlign: 'center',
          cursor: 'pointer',
          border: '2px dashed',
          borderColor: isDragActive ? 'primary.main' : 'grey.400',
          bgcolor: isDragActive ? 'action.hover' : 'background.paper',
          transition: 'all 0.3s',
          '&:hover': {
            borderColor: 'primary.main',
            bgcolor: 'action.hover'
          }
        }}
      >
        <input {...getInputProps()} />
        <CloudUploadIcon sx={{ fontSize: 64, color: 'primary.main', mb: 2 }} />
        {isDragActive ? (
          <Typography>Drop the file here...</Typography>
        ) : (
          <>
            <Typography variant="h6" gutterBottom>
              Drag & drop survey file here
            </Typography>
            <Typography variant="body2" color="text.secondary">
              or click to select file
            </Typography>
            <Typography variant="caption" color="text.secondary" sx={{ mt: 1, display: 'block' }}>
              Supported formats: .xlsx, .csv (max 50MB)
            </Typography>
          </>
        )}
      </Paper>

      {/* File Rejections */}
      {fileRejections.length > 0 && (
        <Alert severity="error" sx={{ mt: 2 }}>
          {fileRejections[0].errors[0].message}
        </Alert>
      )}

      {/* Selected File Info */}
      {selectedFile && !isUploading && (
        <Box sx={{ mt: 2, p: 2, bgcolor: 'grey.100', borderRadius: 1 }}>
          <Typography variant="subtitle2">Selected File:</Typography>
          <Typography variant="body2">
            {selectedFile.name} ({formatFileSize(selectedFile.size)})
          </Typography>
          <Button
            variant="contained"
            fullWidth
            sx={{ mt: 2 }}
            onClick={handleUpload}
          >
            Upload and Process
          </Button>
        </Box>
      )}

      {/* Upload Progress */}
      {isUploading && (
        <Box sx={{ mt: 2 }}>
          <Typography variant="body2" gutterBottom>
            Uploading... {uploadProgress}%
          </Typography>
          <LinearProgress variant="determinate" value={uploadProgress} />
        </Box>
      )}

      {/* Error Display */}
      {error && (
        <Alert severity="error" sx={{ mt: 2 }}>
          {error}
        </Alert>
      )}
    </Box>
  );
};
```

### Upload API Hook

**File Location:** `apps/web/src/hooks/useSurveyUpload.ts`

```typescript
import { useState } from 'react';
import { surveyApi } from '../api/surveyApi';

interface UploadParams {
  file: File;
  runId: string;
  surveyType: string;
  onProgress?: (progress: number) => void;
}

interface UploadResult {
  surveyDataId: string;
  message: string;
}

export const useSurveyUpload = () => {
  const [isUploading, setIsUploading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const uploadSurvey = async (params: UploadParams): Promise<UploadResult> => {
    setIsUploading(true);
    setError(null);

    try {
      const formData = new FormData();
      formData.append('file', params.file);
      formData.append('run_id', params.runId);
      formData.append('survey_type', params.surveyType);

      const result = await surveyApi.uploadSurveyFile(formData, params.onProgress);

      return {
        surveyDataId: result.survey_data.id,
        message: result.message
      };
    } catch (err: any) {
      const errorMessage = err.response?.data?.error || err.message || 'Upload failed';
      setError(errorMessage);
      throw new Error(errorMessage);
    } finally {
      setIsUploading(false);
    }
  };

  return { uploadSurvey, isUploading, error };
};
```

### Processing Status Component

**File Location:** `apps/web/src/components/survey/ProcessingStatus.tsx`

```typescript
import React, { useEffect } from 'react';
import {
  Box,
  Stepper,
  Step,
  StepLabel,
  CircularProgress,
  Typography,
  Alert
} from '@mui/material';
import CheckCircleIcon from '@mui/icons-material/CheckCircle';
import ErrorIcon from '@mui/icons-material/Error';
import { useSurveyStatus } from '../../hooks/useSurveyStatus';

interface ProcessingStatusProps {
  surveyDataId: string;
  onComplete: () => void;
  onError: (error: string) => void;
}

const PROCESSING_STEPS = [
  'Uploading',
  'Validating',
  'Calculating',
  'Interpolating',
  'Complete'
];

export const ProcessingStatus: React.FC<ProcessingStatusProps> = ({
  surveyDataId,
  onComplete,
  onError
}) => {
  const { status, isLoading, error } = useSurveyStatus(surveyDataId);

  useEffect(() => {
    if (status === 'complete') {
      onComplete();
    } else if (status === 'error' || error) {
      onError(error || 'Processing failed');
    }
  }, [status, error, onComplete, onError]);

  const getCurrentStep = (): number => {
    switch (status) {
      case 'uploading':
        return 0;
      case 'validating':
        return 1;
      case 'calculating':
        return 2;
      case 'interpolating':
        return 3;
      case 'complete':
        return 4;
      default:
        return 0;
    }
  };

  const activeStep = getCurrentStep();

  return (
    <Box sx={{ width: '100%', maxWidth: 800, mx: 'auto', mt: 4 }}>
      <Typography variant="h5" gutterBottom textAlign="center">
        Processing Survey Data
      </Typography>

      <Stepper activeStep={activeStep} sx={{ mt: 4 }}>
        {PROCESSING_STEPS.map((label, index) => {
          const isError = status === 'error' && index === activeStep;
          const isComplete = index < activeStep || status === 'complete';

          return (
            <Step key={label}>
              <StepLabel
                error={isError}
                StepIconComponent={() => {
                  if (isError) {
                    return <ErrorIcon color="error" />;
                  } else if (isComplete) {
                    return <CheckCircleIcon color="success" />;
                  } else if (index === activeStep) {
                    return <CircularProgress size={24} />;
                  }
                  return null;
                }}
              >
                {label}
              </StepLabel>
            </Step>
          );
        })}
      </Stepper>

      {isLoading && (
        <Box sx={{ textAlign: 'center', mt: 4 }}>
          <CircularProgress />
          <Typography variant="body2" sx={{ mt: 2 }}>
            {PROCESSING_STEPS[activeStep]}...
          </Typography>
        </Box>
      )}

      {error && (
        <Alert severity="error" sx={{ mt: 3 }}>
          {error}
        </Alert>
      )}
    </Box>
  );
};
```

### Status Polling Hook

**File Location:** `apps/web/src/hooks/useSurveyStatus.ts`

```typescript
import { useQuery } from '@tanstack/react-query';
import { surveyApi } from '../api/surveyApi';

export const useSurveyStatus = (surveyDataId: string) => {
  const { data, isLoading, error } = useQuery({
    queryKey: ['surveyStatus', surveyDataId],
    queryFn: () => surveyApi.getSurveyStatus(surveyDataId),
    refetchInterval: (data) => {
      // Stop polling when complete or error
      if (data?.status === 'complete' || data?.status === 'error') {
        return false;
      }
      return 2000;  // Poll every 2 seconds
    },
    enabled: !!surveyDataId
  });

  return {
    status: data?.status || 'uploading',
    isLoading,
    error: error?.message || data?.error || null
  };
};
```

### Survey Results Page

**File Location:** `apps/web/src/pages/runs/SurveyResultsPage.tsx`

```typescript
import React, { useState } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import {
  Container,
  Box,
  Paper,
  Typography,
  Grid,
  Breadcrumbs,
  Link,
  Divider,
  ToggleButtonGroup,
  ToggleButton
} from '@mui/material';
import { Plot2D, PlotType } from '../../components/visualization/Plot2D';
import { Plot3D } from '../../components/visualization/Plot3D';
import { DataSourceToggle } from '../../components/visualization/DataSourceToggle';
import { DownloadButton } from '../../components/survey/DownloadButton';
import { useSurveyPlotData } from '../../hooks/useSurveyPlotData';

export const SurveyResultsPage: React.FC = () => {
  const { runId, surveyDataId } = useParams<{ runId: string; surveyDataId: string }>();
  const navigate = useNavigate();

  const [dataSource, setDataSource] = useState<'calculated' | 'interpolated'>('calculated');
  const [plotType2D, setPlotType2D] = useState<PlotType>('vertical');
  const [resolution, setResolution] = useState(10);

  const { data: surveyData, isLoading, error } = useSurveyPlotData(
    surveyDataId!,
    dataSource,
    resolution
  );

  return (
    <Container maxWidth="xl" sx={{ mt: 4, mb: 4 }}>
      {/* Breadcrumbs */}
      <Breadcrumbs sx={{ mb: 3 }}>
        <Link color="inherit" href="/runs" onClick={() => navigate('/runs')}>
          Runs
        </Link>
        <Link color="inherit" href={`/runs/${runId}`} onClick={() => navigate(`/runs/${runId}`)}>
          Run Details
        </Link>
        <Typography color="text.primary">Survey Results</Typography>
      </Breadcrumbs>

      {/* Page Header */}
      <Typography variant="h4" gutterBottom>
        Survey Results
      </Typography>

      {/* File Metadata */}
      <Paper sx={{ p: 3, mb: 3 }}>
        <Typography variant="h6" gutterBottom>
          File Information
        </Typography>
        <Grid container spacing={2}>
          <Grid item xs={12} sm={6} md={3}>
            <Typography variant="body2" color="text.secondary">
              Filename
            </Typography>
            <Typography variant="body1">
              {surveyData?.metadata.filename || 'N/A'}
            </Typography>
          </Grid>
          <Grid item xs={12} sm={6} md={3}>
            <Typography variant="body2" color="text.secondary">
              Upload Date
            </Typography>
            <Typography variant="body1">
              {surveyData?.metadata.uploadDate || 'N/A'}
            </Typography>
          </Grid>
          <Grid item xs={12} sm={6} md={3}>
            <Typography variant="body2" color="text.secondary">
              Data Points
            </Typography>
            <Typography variant="body1">
              {surveyData?.pointCount || 0}
            </Typography>
          </Grid>
          <Grid item xs={12} sm={6} md={3}>
            <Typography variant="body2" color="text.secondary">
              Processing Time
            </Typography>
            <Typography variant="body1">
              {surveyData?.metadata.processingDuration || 'N/A'}
            </Typography>
          </Grid>
        </Grid>
      </Paper>

      {/* Data Source Toggle */}
      <Box sx={{ mb: 3, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
        <DataSourceToggle
          value={dataSource}
          onChange={setDataSource}
          calculatedCount={surveyData?.calculatedCount || 0}
          interpolatedCount={surveyData?.interpolatedCount || 0}
        />

        {/* Download Buttons */}
        <Box sx={{ display: 'flex', gap: 2 }}>
          <DownloadButton surveyId={surveyDataId!} dataType="calculated" />
          {dataSource === 'interpolated' && (
            <DownloadButton surveyId={surveyDataId!} dataType="interpolated" />
          )}
        </Box>
      </Box>

      <Divider sx={{ mb: 3 }} />

      {/* 3D Visualization */}
      <Paper sx={{ p: 3, mb: 3 }}>
        <Typography variant="h6" gutterBottom>
          3D Wellbore Trajectory
        </Typography>
        <Plot3D
          surveyData={surveyData}
          isLoading={isLoading}
          error={error}
          showStartMarker={true}
          showEndMarker={true}
        />
      </Paper>

      {/* 2D Visualizations */}
      <Paper sx={{ p: 3 }}>
        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 2 }}>
          <Typography variant="h6">
            2D Trajectory Views
          </Typography>

          {/* Plot Type Selector */}
          <ToggleButtonGroup
            value={plotType2D}
            exclusive
            onChange={(_, newType) => {
              if (newType !== null) setPlotType2D(newType);
            }}
            size="small"
          >
            <ToggleButton value="vertical">Vertical Section</ToggleButton>
            <ToggleButton value="plan">Plan View</ToggleButton>
            <ToggleButton value="inclination">Inclination</ToggleButton>
            <ToggleButton value="azimuth">Azimuth</ToggleButton>
          </ToggleButtonGroup>
        </Box>

        <Plot2D
          plotType={plotType2D}
          surveyData={surveyData}
          isLoading={isLoading}
          error={error}
        />
      </Paper>
    </Container>
  );
};
```

### API Methods

**Add to `apps/web/src/api/surveyApi.ts`:**
```typescript
export const surveyApi = {
  // ... existing methods ...

  async uploadSurveyFile(
    formData: FormData,
    onProgress?: (progress: number) => void
  ): Promise<any> {
    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();

      xhr.upload.addEventListener('progress', (event) => {
        if (event.lengthComputable && onProgress) {
          const progress = Math.round((event.loaded / event.total) * 100);
          onProgress(progress);
        }
      });

      xhr.addEventListener('load', () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          resolve(JSON.parse(xhr.responseText));
        } else {
          reject(new Error(`Upload failed: ${xhr.statusText}`));
        }
      });

      xhr.addEventListener('error', () => {
        reject(new Error('Network error'));
      });

      xhr.open('POST', '/api/surveys/upload/');
      xhr.setRequestHeader('Authorization', `Bearer ${getAuthToken()}`);
      xhr.send(formData);
    });
  },

  async getSurveyStatus(surveyDataId: string): Promise<any> {
    const response = await fetch(`/api/surveys/status/${surveyDataId}/`, {
      headers: {
        'Authorization': `Bearer ${getAuthToken()}`
      }
    });

    if (!response.ok) {
      throw new Error(`Failed to get survey status: ${response.statusText}`);
    }

    return response.json();
  }
};
```

### Integration Test Example

**File Location:** `apps/web/cypress/e2e/survey-workflow.cy.ts`

```typescript
describe('Survey Upload and Calculation Workflow', () => {
  beforeEach(() => {
    cy.login();  // Custom command for authentication
    cy.visit('/runs/test-run-id');
  });

  it('should complete full survey workflow', () => {
    // Step 1: Upload file
    cy.contains('Upload Survey File').click();

    cy.get('input[type="file"]').selectFile('cypress/fixtures/sample-survey.xlsx', {
      force: true
    });

    cy.contains('Upload and Process').click();

    // Step 2: Monitor processing status
    cy.contains('Processing Survey Data', { timeout: 10000 }).should('be.visible');
    cy.contains('Validating').should('be.visible');
    cy.contains('Calculating').should('be.visible');
    cy.contains('Complete', { timeout: 30000 }).should('be.visible');

    // Step 3: Verify results page
    cy.url().should('include', '/surveys/');
    cy.contains('Survey Results').should('be.visible');

    // Step 4: Verify visualizations
    cy.contains('3D Wellbore Trajectory').should('be.visible');
    cy.contains('2D Trajectory Views').should('be.visible');

    // Step 5: Download results
    cy.contains('Download calculated').click();
    cy.contains('Excel (.xlsx)').click();

    // Verify download started
    cy.readFile('cypress/downloads/test-run-calculated-*.xlsx', { timeout: 10000 })
      .should('exist');
  });

  it('should handle upload errors', () => {
    cy.contains('Upload Survey File').click();

    // Upload invalid file
    cy.get('input[type="file"]').selectFile('cypress/fixtures/invalid-file.txt', {
      force: true
    });

    cy.contains('Upload and Process').click();

    // Verify error message
    cy.contains('Invalid file type', { timeout: 5000 }).should('be.visible');
  });
});
```

### Responsive Design Breakpoints

**Mobile (< 768px):**
- Single column layout
- Stack plots vertically
- Reduce plot height to 400px
- Collapse navigation

**Tablet (768px - 1024px):**
- Single column layout
- Plot height 500px
- Show compact plot controls

**Desktop (> 1024px):**
- Grid layout (2 columns for metadata, full width for plots)
- Plot height 600-700px
- Full plot controls and toolbar

**Media Query Example:**
```typescript
const theme = useTheme();
const isMobile = useMediaQuery(theme.breakpoints.down('sm'));
const isTablet = useMediaQuery(theme.breakpoints.between('sm', 'md'));

const plotHeight = isMobile ? 400 : isTablet ? 500 : 700;
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-13 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
- TypeScript compilation: PASSED (no errors)
- React-dropzone installation: SUCCESS (with --legacy-peer-deps flag due to peer dependency conflicts)

### Completion Notes List

**Tasks 1-5 Completed Successfully:**

1. **File Upload Component** - Created comprehensive drag-and-drop component with:
   - React-dropzone integration for intuitive file selection
   - File type validation (.xlsx, .csv only)
   - File size validation (50MB max)
   - Real-time upload progress tracking
   - Survey type selector dropdown
   - Responsive Material-UI design

2. **Upload API Integration** - Added upload functionality to surveysService:
   - XMLHttpRequest for progress tracking
   - Multipart form-data handling
   - Error handling with specific messages
   - Authentication token integration
   - Status polling endpoint

3. **Processing Status Tracking** - Created real-time status component:
   - Custom polling hook with 2-second intervals
   - Material-UI Stepper for visual progress
   - 5 stages: uploading → validating → calculating → interpolating → complete
   - Auto-stops polling on completion or error
   - Error state handling with retry capability

4. **Survey Results Page** - Built comprehensive results visualization:
   - Integration with existing Plot2D and Plot3D components from Story 4.4
   - Created new DownloadButton component for Excel/CSV export
   - File metadata display (filename, upload date, data points, processing time)
   - Data source toggle (calculated/interpolated)
   - Plot type selector (vertical, plan, inclination, azimuth)
   - Responsive grid layout with breadcrumb navigation

5. **Run Detail Page Integration** - Enhanced existing page with:
   - "Upload Survey File" button in page actions
   - Modal dialog workflow (upload → processing → results)
   - Survey type selector in upload form
   - Automatic navigation to results page on completion
   - Error handling for failed uploads

### File List

**Created Files:**
- `apps/web/src/components/survey/SurveyFileUpload.tsx` (203 lines) - File upload component
- `apps/web/src/components/survey/ProcessingStatus.tsx` (114 lines) - Status tracking component
- `apps/web/src/components/survey/DownloadButton.tsx` (108 lines) - Download button with format menu
- `apps/web/src/hooks/useSurveyUpload.ts` (55 lines) - Upload hook
- `apps/web/src/hooks/useSurveyStatus.ts` (76 lines) - Status polling hook
- `apps/web/src/hooks/useSurveyPlotData.ts` (94 lines) - Plot data fetching hook
- `apps/web/src/pages/runs/SurveyResultsPage.tsx` (206 lines) - Survey results page

**Modified Files:**
- `apps/web/src/services/surveysService.ts` - Added uploadSurveyFile() and getSurveyStatus() methods
- `apps/web/src/pages/runs/RunDetailPage.tsx` - Added upload dialog and handlers
- `apps/web/src/App.tsx` - Added route for SurveyResultsPage
- `package.json` (apps/web) - Added react-dropzone dependency

**Total Lines of Code:** ~856 lines (new) + ~150 lines (modified) = ~1006 lines

**Tasks 6-8 Completed (2025-10-15):**

Task 6: Multiple File Support
- Created `SurveyFileList.tsx` component (280 lines)
- Displays all survey files with status badges (pending, processing, completed, failed)
- Integrated with RunDetailPage
- Added SurveyFile type definitions to run.types.ts
- Supports file deletion with confirmation dialog
- Click to view results navigation

Task 7: Error Handling and Notifications
- Created `ErrorDisplay.tsx` component (180 lines)
- Supports validation errors with collapsible details
- Created specialized error components (UploadErrorDisplay, CalculationErrorDisplay, ValidationWarningDisplay, ProcessingErrorDisplay)
- Created `SuccessNotification.tsx` component (150 lines)
- Supports success notifications with auto-dismiss
- Created specialized success components (UploadSuccessNotification, CalculationSuccessNotification, etc.)
- Added retry capability for failed operations

Task 8: State Management with React Query
- Installed @tanstack/react-query v5.90.3
- Updated `useSurveyUpload.ts` with React Query useMutation
- Implemented optimistic updates for file uploads
- Implemented automatic retry logic (retry network errors, skip validation errors)
- Updated `useSurveyStatus.ts` with React Query useQuery
- Implemented automatic polling (every 2 seconds) with auto-stop on complete/error
- Added QueryClientProvider to App.tsx with global configuration
- Configured caching: 5 min stale time, 10 min garbage collection

**Tasks Remaining:**
- Task 9: Write Unit Tests (>80% coverage)
- Task 10: Write Integration Tests (Cypress e2e tests)

## QA Results
_To be filled by QA agent_
