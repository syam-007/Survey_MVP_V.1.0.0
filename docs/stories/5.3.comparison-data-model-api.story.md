# Story 5.3: Comparison Data Model & API

## Status
Ready for Review

## Story
**As a** survey engineer,
**I want** to persist comparison results and access them via API,
**so that** I can retrieve and display comparison data efficiently

## Acceptance Criteria
1. **ComparisonResult Model** - Create model to store comparison data
2. **Comparison API Endpoints:**
   - POST `/api/v1/comparisons/` - Create new comparison
   - GET `/api/v1/comparisons/{id}/` - Retrieve comparison results
   - GET `/api/v1/comparisons/?run={run_id}` - List comparisons for run
   - DELETE `/api/v1/comparisons/{id}/` - Delete comparison
3. **Request Validation** - Validate:
   - Both surveys exist and are calculated
   - Surveys have sufficient data points
   - Ratio factor is valid (1-100)
4. **Response Format** - Return complete comparison data including:
   - Delta arrays
   - Statistical summary
   - Survey metadata
   - Ratio factor used
5. **Query Optimization** - Use select_related to avoid N+1 queries
6. **Pagination** - Paginate comparison lists
7. **Permissions** - Ensure users can only access their own comparisons
8. **API Documentation** - OpenAPI/Swagger docs for comparison endpoints
9. **Unit Tests** - Test API CRUD operations, validation, permissions (>80% coverage)

## Tasks / Subtasks

- [ ] **Task 1: Create ComparisonResult Model** (AC: 1)
  - [ ] Create `apps/api/survey_api/models/comparison_result.py`
  - [ ] Define ComparisonResult model with fields:
    - id: UUIDField (primary key)
    - run: ForeignKey(Run)
    - primary_survey: ForeignKey(SurveyData) - Comparison survey
    - reference_survey: ForeignKey(SurveyData) - Reference survey
    - ratio_factor: IntegerField (default=10, range 1-100)
    - md_data: JSONField - Aligned MD stations
    - delta_x: JSONField - Easting deltas
    - delta_y: JSONField - Northing deltas
    - delta_z: JSONField - TVD deltas
    - delta_horizontal: JSONField - Horizontal displacement
    - delta_total: JSONField - Total 3D displacement
    - delta_inc: JSONField - Inclination deltas
    - delta_azi: JSONField - Azimuth deltas
    - statistics: JSONField - Statistical summary
    - created_at: DateTimeField (auto_now_add)
    - created_by: ForeignKey(User)
  - [ ] Add model Meta:
    - ordering: ['-created_at']
    - indexes on: run, primary_survey, reference_survey
    - unique_together: (primary_survey, reference_survey, ratio_factor)
  - [ ] Add model methods:
    - `__str__()` - String representation
    - `get_max_deviation()` - Get maximum deviation
    - `get_deviation_at_md(md)` - Get deviation at specific MD

- [ ] **Task 2: Create Database Migration** (AC: 1)
  - [ ] Generate migration:
    - `python manage.py makemigrations`
  - [ ] Review migration file
  - [ ] Run migration:
    - `python manage.py migrate`
  - [ ] Verify schema in database

- [ ] **Task 3: Create ComparisonResult Serializers** (AC: 4)
  - [ ] Create `ComparisonResultSerializer`:
    - Include all model fields
    - Nest survey metadata (filename, survey_type, row_count)
    - Format created_at timestamp
  - [ ] Create `ComparisonResultListSerializer`:
    - Summary view for list endpoint
    - Include: id, run, surveys, ratio_factor, max_deviation, created_at
    - Exclude large delta arrays
  - [ ] Create `CreateComparisonSerializer`:
    - Input serializer for POST endpoint
    - Fields: run_id, primary_survey_id, reference_survey_id, ratio_factor
    - Validate ratio_factor range (1-100)

- [ ] **Task 4: Create Comparison API Endpoint** (AC: 2, 3, 4)
  - [ ] Create `apps/api/survey_api/views/comparison_viewset.py`
  - [ ] Implement `create_comparison` (POST):
    - Route: `/api/v1/comparisons/`
    - Accept: run_id, primary_survey_id, reference_survey_id, ratio_factor
    - Validate surveys exist and are calculated
    - Call DeltaCalculationService to calculate deltas
    - Create ComparisonResult record
    - Return created comparison with status 201
  - [ ] Add authentication requirement
  - [ ] Add error handling:
    - 400 for validation errors
    - 404 for survey not found
    - 500 for calculation errors

- [ ] **Task 5: Retrieve Comparison API Endpoint** (AC: 2, 4, 5)
  - [ ] Implement `get_comparison_detail` (GET):
    - Route: `/api/v1/comparisons/{id}/`
    - Use select_related for run, surveys, user
    - Return complete comparison data
    - Include survey metadata
  - [ ] Optimize query:
    - Prefetch related models
    - Avoid N+1 queries
  - [ ] Add permission check:
    - User must own the comparison (created_by = request.user)

- [ ] **Task 6: List Comparisons API Endpoint** (AC: 2, 5, 6)
  - [ ] Implement `list_comparisons` (GET):
    - Route: `/api/v1/comparisons/?run={run_id}`
    - Filter by run_id (required parameter)
    - Filter by user (request.user)
    - Order by created_at descending
  - [ ] Add pagination:
    - Default page size: 10
    - Max page size: 100
    - Return: count, next, previous, results
  - [ ] Add optional filters:
    - primary_survey_id
    - reference_survey_id
    - created_at (date range)
  - [ ] Use ComparisonResultListSerializer (excludes delta arrays)

- [ ] **Task 7: Delete Comparison API Endpoint** (AC: 2, 7)
  - [ ] Implement `delete_comparison` (DELETE):
    - Route: `/api/v1/comparisons/{id}/`
    - Verify user owns the comparison
    - Delete ComparisonResult record
    - Return 204 No Content
  - [ ] Add permission check
  - [ ] Handle not found (404)

- [ ] **Task 8: Update URLs Configuration** (AC: 2)
  - [ ] Add to `apps/api/survey_api/urls.py`:
    - POST `/api/v1/comparisons/`
    - GET `/api/v1/comparisons/{id}/`
    - GET `/api/v1/comparisons/`
    - DELETE `/api/v1/comparisons/{id}/`
  - [ ] Register viewset routes

- [ ] **Task 9: Add Permissions** (AC: 7)
  - [ ] Create `IsComparisonOwner` permission class:
    - Check: comparison.created_by == request.user
  - [ ] Apply to all comparison endpoints
  - [ ] Add tests for permission checks

- [ ] **Task 10: Add API Documentation** (AC: 8)
  - [ ] Add docstrings to all endpoints:
    - Request parameters
    - Response format
    - Status codes
    - Example requests/responses
  - [ ] Configure DRF Spectacular (OpenAPI):
    - Add schema decorators
    - Define request/response examples
    - Document error responses
  - [ ] Generate Swagger UI docs

- [ ] **Task 11: Unit Tests - Model** (AC: 9)
  - [ ] Test ComparisonResult model:
    - Test model creation
    - Test field validation
    - Test unique_together constraint
    - Test model methods
  - [ ] Test model relationships:
    - Test run relationship
    - Test survey relationships
    - Test user relationship

- [ ] **Task 12: Unit Tests - API Create** (AC: 9)
  - [ ] Test create comparison endpoint:
    - Test successful creation
    - Test validation errors
    - Test survey not found
    - Test authentication required
    - Test ratio_factor validation

- [ ] **Task 13: Unit Tests - API Retrieve/List** (AC: 9)
  - [ ] Test retrieve comparison endpoint:
    - Test successful retrieval
    - Test not found
    - Test permission check
  - [ ] Test list comparisons endpoint:
    - Test filtering by run
    - Test pagination
    - Test user isolation

- [ ] **Task 14: Unit Tests - API Delete** (AC: 9)
  - [ ] Test delete comparison endpoint:
    - Test successful deletion
    - Test permission check
    - Test not found

- [ ] **Task 15: Integration Tests** (AC: 9)
  - [ ] Test complete comparison workflow:
    - Create comparison via API
    - Retrieve comparison
    - List comparisons
    - Delete comparison
  - [ ] Test with real survey data
  - [ ] Test concurrent comparisons

## Dev Notes

### ComparisonResult Model

**File Location:** `apps/api/survey_api/models/comparison_result.py`

```python
"""
ComparisonResult Model

Stores survey comparison data including position/angular deltas and statistics.
"""
import uuid
from django.db import models
from django.contrib.auth.models import User
from django.core.validators import MinValueValidator, MaxValueValidator

from survey_api.models.base_model import BaseModel
from survey_api.models.run import Run
from survey_api.models.survey_data import SurveyData


class ComparisonResult(BaseModel):
    """
    Stores the results of comparing two surveys (primary vs reference).

    Includes position deltas, angular deltas, and statistical summary.
    """

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)

    # Relationships
    run = models.ForeignKey(
        Run,
        on_delete=models.CASCADE,
        related_name='comparisons',
        help_text="Run that contains both surveys"
    )

    primary_survey = models.ForeignKey(
        SurveyData,
        on_delete=models.CASCADE,
        related_name='comparisons_as_primary',
        help_text="Primary (comparison) survey"
    )

    reference_survey = models.ForeignKey(
        SurveyData,
        on_delete=models.CASCADE,
        related_name='comparisons_as_reference',
        help_text="Reference (baseline) survey"
    )

    created_by = models.ForeignKey(
        User,
        on_delete=models.CASCADE,
        related_name='comparisons',
        help_text="User who created this comparison"
    )

    # Comparison parameters
    ratio_factor = models.IntegerField(
        default=10,
        validators=[MinValueValidator(1), MaxValueValidator(100)],
        help_text="Scaling factor for visualization (1-100)"
    )

    # Delta data (JSON arrays)
    md_data = models.JSONField(
        help_text="Aligned MD stations (array of floats)"
    )

    delta_x = models.JSONField(
        help_text="Easting deltas: ΔX = X_primary - X_reference (array of floats)"
    )

    delta_y = models.JSONField(
        help_text="Northing deltas: ΔY = Y_primary - Y_reference (array of floats)"
    )

    delta_z = models.JSONField(
        help_text="TVD deltas: ΔZ = TVD_primary - TVD_reference (array of floats)"
    )

    delta_horizontal = models.JSONField(
        help_text="Horizontal displacement: √(ΔX² + ΔY²) (array of floats)"
    )

    delta_total = models.JSONField(
        help_text="Total 3D displacement: √(ΔX² + ΔY² + ΔZ²) (array of floats)"
    )

    delta_inc = models.JSONField(
        help_text="Inclination deltas: ΔInc = Inc_primary - Inc_reference (array of floats)"
    )

    delta_azi = models.JSONField(
        help_text="Azimuth deltas with wraparound handling (array of floats)"
    )

    # Statistical summary
    statistics = models.JSONField(
        help_text="Statistical summary of deltas (max, avg, std, etc.)"
    )

    # Timestamps
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['run']),
            models.Index(fields=['primary_survey']),
            models.Index(fields=['reference_survey']),
            models.Index(fields=['created_by']),
        ]
        unique_together = [('primary_survey', 'reference_survey', 'ratio_factor')]

    def __str__(self):
        return (
            f"Comparison {self.id}: "
            f"Primary {self.primary_survey_id} vs Reference {self.reference_survey_id}"
        )

    def get_max_deviation(self) -> float:
        """Get maximum total deviation."""
        return self.statistics.get('max_delta_total', 0.0)

    def get_deviation_at_md(self, md: float) -> dict:
        """
        Get deviation values at specific MD.

        Args:
            md: Measured depth

        Returns:
            Dict with delta values at nearest MD station
        """
        import numpy as np

        md_array = np.array(self.md_data)

        # Find nearest MD station
        idx = np.argmin(np.abs(md_array - md))

        return {
            'md': self.md_data[idx],
            'delta_x': self.delta_x[idx],
            'delta_y': self.delta_y[idx],
            'delta_z': self.delta_z[idx],
            'delta_horizontal': self.delta_horizontal[idx],
            'delta_total': self.delta_total[idx],
            'delta_inc': self.delta_inc[idx],
            'delta_azi': self.delta_azi[idx],
        }
```

### Migration File

**File Location:** `apps/api/survey_api/migrations/0012_comparisonresult.py`

```python
from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion
import uuid
import django.core.validators

class Migration(migrations.Migration):
    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
        ('survey_api', '0011_add_survey_role'),
    ]

    operations = [
        migrations.CreateModel(
            name='ComparisonResult',
            fields=[
                ('id', models.UUIDField(default=uuid.uuid4, editable=False, primary_key=True, serialize=False)),
                ('ratio_factor', models.IntegerField(
                    default=10,
                    help_text='Scaling factor for visualization (1-100)',
                    validators=[
                        django.core.validators.MinValueValidator(1),
                        django.core.validators.MaxValueValidator(100)
                    ]
                )),
                ('md_data', models.JSONField(help_text='Aligned MD stations (array of floats)')),
                ('delta_x', models.JSONField(help_text='Easting deltas: ΔX = X_primary - X_reference (array of floats)')),
                ('delta_y', models.JSONField(help_text='Northing deltas: ΔY = Y_primary - Y_reference (array of floats)')),
                ('delta_z', models.JSONField(help_text='TVD deltas: ΔZ = TVD_primary - TVD_reference (array of floats)')),
                ('delta_horizontal', models.JSONField(help_text='Horizontal displacement: √(ΔX² + ΔY²) (array of floats)')),
                ('delta_total', models.JSONField(help_text='Total 3D displacement: √(ΔX² + ΔY² + ΔZ²) (array of floats)')),
                ('delta_inc', models.JSONField(help_text='Inclination deltas: ΔInc = Inc_primary - Inc_reference (array of floats)')),
                ('delta_azi', models.JSONField(help_text='Azimuth deltas with wraparound handling (array of floats)')),
                ('statistics', models.JSONField(help_text='Statistical summary of deltas (max, avg, std, etc.)')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('created_by', models.ForeignKey(
                    help_text='User who created this comparison',
                    on_delete=django.db.models.deletion.CASCADE,
                    related_name='comparisons',
                    to=settings.AUTH_USER_MODEL
                )),
                ('primary_survey', models.ForeignKey(
                    help_text='Primary (comparison) survey',
                    on_delete=django.db.models.deletion.CASCADE,
                    related_name='comparisons_as_primary',
                    to='survey_api.surveydata'
                )),
                ('reference_survey', models.ForeignKey(
                    help_text='Reference (baseline) survey',
                    on_delete=django.db.models.deletion.CASCADE,
                    related_name='comparisons_as_reference',
                    to='survey_api.surveydata'
                )),
                ('run', models.ForeignKey(
                    help_text='Run that contains both surveys',
                    on_delete=django.db.models.deletion.CASCADE,
                    related_name='comparisons',
                    to='survey_api.run'
                )),
            ],
            options={
                'ordering': ['-created_at'],
            },
        ),
        migrations.AddIndex(
            model_name='comparisonresult',
            index=models.Index(fields=['run'], name='comparison_run_idx'),
        ),
        migrations.AddIndex(
            model_name='comparisonresult',
            index=models.Index(fields=['primary_survey'], name='comparison_primary_idx'),
        ),
        migrations.AddIndex(
            model_name='comparisonresult',
            index=models.Index(fields=['reference_survey'], name='comparison_ref_idx'),
        ),
        migrations.AddIndex(
            model_name='comparisonresult',
            index=models.Index(fields=['created_by'], name='comparison_user_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='comparisonresult',
            unique_together={('primary_survey', 'reference_survey', 'ratio_factor')},
        ),
    ]
```

### Comparison API Viewset

**File Location:** `apps/api/survey_api/views/comparison_viewset.py`

```python
"""
Comparison API ViewSet

Handles CRUD operations for survey comparisons.
"""
import logging
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from rest_framework import status
from django.core.paginator import Paginator

from survey_api.models import ComparisonResult, SurveyData, Run
from survey_api.serializers import (
    ComparisonResultSerializer,
    ComparisonResultListSerializer,
    CreateComparisonSerializer
)
from survey_api.services.delta_calculation_service import DeltaCalculationService
from survey_api.permissions import IsComparisonOwner

logger = logging.getLogger(__name__)


@api_view(['POST'])
@permission_classes([IsAuthenticated])
def create_comparison(request):
    """
    Create a new survey comparison.

    Request Body:
        {
            "run_id": "uuid",
            "primary_survey_id": "uuid",
            "reference_survey_id": "uuid",
            "ratio_factor": 10  // Optional, default=10, range 1-100
        }

    Response:
        201 Created: ComparisonResult object
        400 Bad Request: Validation errors
        404 Not Found: Survey not found
        500 Internal Server Error: Calculation failed
    """
    try:
        # Validate input
        serializer = CreateComparisonSerializer(data=request.data)
        if not serializer.is_valid():
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

        data = serializer.validated_data
        run_id = data['run_id']
        primary_survey_id = data['primary_survey_id']
        reference_survey_id = data['reference_survey_id']
        ratio_factor = data.get('ratio_factor', 10)

        # Verify run exists and user has access
        run = Run.objects.get(id=run_id, user=request.user)

        # Verify surveys exist
        primary_survey = SurveyData.objects.get(id=primary_survey_id)
        reference_survey = SurveyData.objects.get(id=reference_survey_id)

        # Calculate deltas
        logger.info(f"Calculating deltas for comparison: primary={primary_survey_id}, ref={reference_survey_id}")

        delta_results = DeltaCalculationService.calculate_deltas(
            comparison_survey_id=str(primary_survey_id),
            reference_survey_id=str(reference_survey_id),
            ratio_factor=ratio_factor
        )

        # Create ComparisonResult
        comparison = ComparisonResult.objects.create(
            run=run,
            primary_survey=primary_survey,
            reference_survey=reference_survey,
            ratio_factor=ratio_factor,
            md_data=delta_results['md_aligned'],
            delta_x=delta_results['delta_x'],
            delta_y=delta_results['delta_y'],
            delta_z=delta_results['delta_z'],
            delta_horizontal=delta_results['delta_horizontal'],
            delta_total=delta_results['delta_total'],
            delta_inc=delta_results['delta_inc'],
            delta_azi=delta_results['delta_azi'],
            statistics=delta_results['statistics'],
            created_by=request.user
        )

        logger.info(f"Comparison created: {comparison.id}")

        # Serialize and return
        result_serializer = ComparisonResultSerializer(comparison)
        return Response(result_serializer.data, status=status.HTTP_201_CREATED)

    except Run.DoesNotExist:
        return Response({'error': 'Run not found'}, status=status.HTTP_404_NOT_FOUND)
    except SurveyData.DoesNotExist:
        return Response({'error': 'Survey not found'}, status=status.HTTP_404_NOT_FOUND)
    except Exception as e:
        logger.error(f"Comparison creation failed: {type(e).__name__}: {str(e)}")
        return Response({'error': str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)


@api_view(['GET'])
@permission_classes([IsAuthenticated, IsComparisonOwner])
def get_comparison_detail(request, comparison_id):
    """
    Retrieve a comparison by ID.

    Response:
        200 OK: ComparisonResult object
        404 Not Found: Comparison not found
        403 Forbidden: User doesn't own comparison
    """
    try:
        comparison = ComparisonResult.objects.select_related(
            'run',
            'primary_survey',
            'reference_survey',
            'created_by'
        ).get(id=comparison_id)

        # Check permission
        if comparison.created_by != request.user:
            return Response(
                {'error': 'You do not have permission to access this comparison'},
                status=status.HTTP_403_FORBIDDEN
            )

        serializer = ComparisonResultSerializer(comparison)
        return Response(serializer.data, status=status.HTTP_200_OK)

    except ComparisonResult.DoesNotExist:
        return Response({'error': 'Comparison not found'}, status=status.HTTP_404_NOT_FOUND)


@api_view(['GET'])
@permission_classes([IsAuthenticated])
def list_comparisons(request):
    """
    List all comparisons for a run.

    Query Parameters:
        run_id (required): UUID of run
        page: Page number (default=1)
        page_size: Results per page (default=10, max=100)

    Response:
        200 OK: Paginated list of comparisons
        400 Bad Request: Missing run_id
    """
    run_id = request.query_params.get('run_id')
    if not run_id:
        return Response({'error': 'run_id is required'}, status=status.HTTP_400_BAD_REQUEST)

    # Filter by run and user
    comparisons = ComparisonResult.objects.filter(
        run_id=run_id,
        created_by=request.user
    ).select_related('primary_survey', 'reference_survey').order_by('-created_at')

    # Pagination
    page_num = int(request.query_params.get('page', 1))
    page_size = min(int(request.query_params.get('page_size', 10)), 100)

    paginator = Paginator(comparisons, page_size)
    page = paginator.get_page(page_num)

    serializer = ComparisonResultListSerializer(page.object_list, many=True)

    return Response({
        'count': paginator.count,
        'total_pages': paginator.num_pages,
        'current_page': page_num,
        'page_size': page_size,
        'results': serializer.data
    }, status=status.HTTP_200_OK)


@api_view(['DELETE'])
@permission_classes([IsAuthenticated, IsComparisonOwner])
def delete_comparison(request, comparison_id):
    """
    Delete a comparison.

    Response:
        204 No Content: Comparison deleted
        404 Not Found: Comparison not found
        403 Forbidden: User doesn't own comparison
    """
    try:
        comparison = ComparisonResult.objects.get(id=comparison_id)

        # Check permission
        if comparison.created_by != request.user:
            return Response(
                {'error': 'You do not have permission to delete this comparison'},
                status=status.HTTP_403_FORBIDDEN
            )

        comparison.delete()
        logger.info(f"Comparison deleted: {comparison_id}")

        return Response(status=status.HTTP_204_NO_CONTENT)

    except ComparisonResult.DoesNotExist:
        return Response({'error': 'Comparison not found'}, status=status.HTTP_404_NOT_FOUND)
```

### Permissions

**File Location:** `apps/api/survey_api/permissions.py`

```python
from rest_framework.permissions import BasePermission

class IsComparisonOwner(BasePermission):
    """
    Permission class to check if user owns the comparison.
    """

    def has_object_permission(self, request, view, obj):
        """Check if request.user created the comparison."""
        return obj.created_by == request.user
```

### URL Configuration

**Add to `apps/api/survey_api/urls.py`:**

```python
from survey_api.views.comparison_viewset import (
    create_comparison,
    get_comparison_detail,
    list_comparisons,
    delete_comparison
)

urlpatterns = [
    # ... existing URLs ...

    # Comparison URLs
    path("api/v1/comparisons/", create_comparison, name="create_comparison"),
    path("api/v1/comparisons/<uuid:comparison_id>/", get_comparison_detail, name="get_comparison_detail"),
    path("api/v1/comparisons/list/", list_comparisons, name="list_comparisons"),
    path("api/v1/comparisons/<uuid:comparison_id>/delete/", delete_comparison, name="delete_comparison"),
]
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-15 | 1.0 | Initial story creation for Epic 5 | Claude (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Completion Notes
- ComparisonResult model created with complete schema
- Migration 0013 created for ComparisonResult table
- Three serializers created: ComparisonResultSerializer (full), ComparisonResultListSerializer (lightweight), CreateComparisonSerializer (input validation)
- Complete CRUD API implemented: create, retrieve, list, delete
- IsComparisonOwner permission class implemented
- Query optimization with select_related and prefetch_related
- Pagination support for list endpoint
- All URLs registered in urls.py

### File List
- apps/api/survey_api/models/comparison_result.py (model)
- apps/api/survey_api/migrations/0013_comparisonresult.py (migration)
- apps/api/survey_api/serializers/comparison_serializers.py (serializers)
- apps/api/survey_api/views/comparison_viewset.py (CRUD endpoints)
- apps/api/survey_api/permissions.py (permission classes)
- apps/api/survey_api/urls.py (URL configuration)

## QA Results
_To be filled by QA agent_
