# Story 5.1: Reference Survey Data Model & Upload

## Status
Ready for Review

## Story
**As a** survey engineer,
**I want** to upload reference survey files for comparison,
**so that** I can analyze deviations between my current survey and a reference trajectory

## Acceptance Criteria
1. **Reference Survey Model** - Extend SurveyFile model to support reference surveys
2. **Survey Role Field** - Add field to distinguish: 'primary', 'reference', 'comparison'
3. **Reference Upload API** - Dedicated endpoint for uploading reference surveys
4. **Automatic Processing** - Trigger calculation and interpolation (resolution=10) for reference surveys
5. **Use Current Run Context** - Apply current run's location, depth, tie-on data to reference survey
6. **Multiple References** - Support multiple reference surveys per run
7. **Reference List** - Track all uploaded reference surveys with metadata
8. **Reuse Capability** - Allow selection of previously uploaded reference surveys
9. **File Association** - Link reference survey to run and primary survey
10. **Upload Dropdown** - Frontend component showing:

    - Previously uploaded reference surveys
    - Option to upload new reference survey
11. **Reference Metadata** - Store: upload date, file name, status, data point count
12. **Database Migration** - Update schema to support reference survey relationships
13. **Unit Tests** - Test reference survey creation, association, retrieval (>80% coverage)

## Tasks / Subtasks

- [ ] **Task 1: Database Schema Updates** (AC: 1, 2, 12)
  - [ ] Add `survey_role` field to SurveyFile model:
    - Type: CharField with choices ('primary', 'reference', 'comparison')
    - Default: 'primary'
    - Required: True
  - [ ] Add `reference_for_survey` field to SurveyFile model:
    - Type: ForeignKey to SurveyFile (nullable)
    - Purpose: Link reference survey to primary survey
    - Related name: 'reference_surveys'
  - [ ] Add database indexes:
    - Index on (run_id, survey_role)
    - Index on reference_for_survey
  - [ ] Create Django migration for schema changes
  - [ ] Run migration on development database
  - [ ] Update model Meta class with appropriate ordering

- [ ] **Task 2: Update SurveyFile Serializers** (AC: 11)
  - [ ] Update `SurveyFileSerializer` to include:
    - `survey_role` field
    - `reference_for_survey` field
    - `reference_surveys` (read-only list of references)
  - [ ] Create `ReferenceSurveySerializer` with fields:
    - id, filename, survey_role, survey_type
    - upload_date, file_size, processing_status
    - survey_data (nested: id, row_count, validation_status)
    - calculated_survey (nested: calculation_status, point_count)
  - [ ] Add validation:
    - survey_role must be valid choice
    - reference_for_survey must exist and be 'primary'
    - Cannot create circular references

- [ ] **Task 3: Reference Upload API Endpoint** (AC: 3, 5, 9)
  - [ ] Create `upload_reference_survey` endpoint:
    - Route: `POST /api/v1/surveys/reference/upload/`
    - Parameters:
      - file (MultipartFile)
      - run_id (UUID)
      - primary_survey_id (UUID, optional)
      - survey_type (String)
    - Authentication: Required
  - [ ] Implement upload logic:
    - Validate file format (.xlsx, .csv)
    - Create SurveyFile with survey_role='reference'
    - Link to primary survey if provided
    - Parse survey data (reuse existing parser)
    - Create SurveyData record
  - [ ] Apply current run context:
    - Use run's location data
    - Use run's depth data
    - Use run's tie-on data
  - [ ] Return response:
    - survey_file_id
    - survey_data_id
    - processing_status
    - message

- [ ] **Task 4: Automatic Calculation & Interpolation** (AC: 4)
  - [ ] Update `trigger_calculation` signal handler:
    - Detect if SurveyData is for reference survey
    - Apply standard calculation workflow
    - Trigger interpolation with resolution=10 (not default 5)
  - [ ] Create `calculate_reference_survey` service method:
    - Call WellengService.calculate_survey()
    - Create CalculatedSurvey record
    - Trigger interpolation at resolution=10
    - Update processing_status to 'completed'
  - [ ] Handle calculation errors:
    - Set processing_status to 'failed'
    - Store error message
    - Log error details

- [ ] **Task 5: Reference Survey List API** (AC: 6, 7, 8)
  - [ ] Create `list_reference_surveys` endpoint:
    - Route: `GET /api/v1/surveys/reference/?run_id={run_id}`
    - Query parameters:
      - run_id (required)
      - primary_survey_id (optional)
    - Authentication: Required
  - [ ] Implement query logic:
    - Filter by run_id
    - Filter by survey_role='reference'
    - Optionally filter by reference_for_survey
    - Order by upload_date (descending)
  - [ ] Return paginated response:
    - count, next, previous, results
    - Each result includes:
      - Reference survey metadata
      - Calculation status
      - Data point counts (raw, calculated, interpolated)
  - [ ] Support filtering:
    - By processing_status
    - By survey_type
    - By date range

- [ ] **Task 6: Reference Detail API** (AC: 11)
  - [ ] Create `get_reference_survey_detail` endpoint:
    - Route: `GET /api/v1/surveys/reference/{id}/`
    - Authentication: Required
  - [ ] Return complete reference survey data:
    - SurveyFile metadata
    - SurveyData (validation, row count)
    - CalculatedSurvey (calculation status, duration, point count)
    - InterpolatedSurvey (interpolation status, resolution, point count)
    - Associated primary survey (if linked)
  - [ ] Include related data:
    - Run information
    - Location, Depth, TieOn context
  - [ ] Handle not found gracefully

- [ ] **Task 7: Frontend - Reference Upload Component** (AC: 10)
  - [ ] Create `ReferenceUploadDropdown.tsx`:
    - Dropdown showing:
      - "Upload New Reference Survey" option
      - List of previously uploaded references
    - Display for each reference:
      - Filename
      - Survey type
      - Upload date
      - Status badge (completed, processing, failed)
      - Data point count
  - [ ] Create `ReferenceUploadModal.tsx`:
    - File upload (drag & drop)
    - Survey type selector
    - Primary survey selector (optional)
    - Upload progress indicator
    - Processing status tracker
  - [ ] Integrate with existing upload component:
    - Reuse SurveyFileUpload component
    - Pass survey_role='reference' parameter
    - Override upload API endpoint

- [ ] **Task 8: Frontend - Reference List Display** (AC: 7, 8)
  - [ ] Create `ReferenceListCard.tsx`:
    - Display all reference surveys for current run
    - Show for each reference:
      - Filename
      - Survey type
      - Upload date
      - Processing status
      - Data points (raw, calculated, interpolated)
      - Associated primary survey (if any)
    - Actions:
      - View details
      - Select for comparison
      - Delete reference
  - [ ] Add to RunDetailPage:
    - Section: "Reference Surveys"
    - List all references
    - Button: "Upload Reference Survey"

- [ ] **Task 9: Frontend - Reference Selection Hook** (AC: 8)
  - [ ] Create `useReferenceSelection.ts`:
    - Fetch list of reference surveys for run
    - Filter by status (only show completed)
    - Cache reference list
    - Refresh on upload completion
  - [ ] Create `useReferenceUpload.ts`:
    - Upload new reference survey
    - Track upload progress
    - Track processing status
    - Handle errors

- [ ] **Task 10: Update Run Detail API** (AC: 6, 9)
  - [ ] Modify `get_run_detail` endpoint:
    - Include list of reference surveys
    - Prefetch reference_surveys relationship
    - Include reference survey counts
  - [ ] Update RunSerializer:
    - Add `reference_surveys` field (nested serializer)
    - Add `reference_survey_count` field

- [ ] **Task 11: Unit Tests - Backend** (AC: 13)
  - [ ] Test SurveyFile model:
    - Test survey_role field validation
    - Test reference_for_survey relationship
    - Test multiple references per run
    - Test circular reference prevention
  - [ ] Test reference upload endpoint:
    - Test successful upload
    - Test file validation
    - Test authentication
    - Test run context application
  - [ ] Test reference list endpoint:
    - Test filtering by run
    - Test filtering by status
    - Test pagination
  - [ ] Test calculation service:
    - Test automatic calculation trigger
    - Test interpolation at resolution=10
    - Test error handling

- [ ] **Task 12: Unit Tests - Frontend** (AC: 13)
  - [ ] Test ReferenceUploadDropdown:
    - Test rendering of reference list
    - Test "Upload New" option
    - Test reference selection
  - [ ] Test ReferenceUploadModal:
    - Test file upload
    - Test survey type selection
    - Test progress tracking
  - [ ] Test useReferenceSelection hook:
    - Test fetching references
    - Test filtering
    - Test caching

- [ ] **Task 13: Integration Tests** (AC: 13)
  - [ ] Test complete reference upload workflow:
    - Upload reference survey
    - Verify calculation triggered
    - Verify interpolation at resolution=10
    - Verify reference appears in list
  - [ ] Test reference reuse:
    - Upload reference once
    - Select for multiple comparisons
    - Verify data consistency
  - [ ] Test multiple references:
    - Upload multiple references per run
    - Verify all tracked correctly
    - Verify no conflicts

## Dev Notes

### Database Schema Changes

**SurveyFile Model Updates:**
```python
class SurveyFile(BaseModel):
    # Existing fields...

    # NEW: Survey role field
    SURVEY_ROLE_CHOICES = [
        ('primary', 'Primary Survey'),
        ('reference', 'Reference Survey'),
        ('comparison', 'Comparison Survey'),
    ]
    survey_role = models.CharField(
        max_length=20,
        choices=SURVEY_ROLE_CHOICES,
        default='primary',
        help_text="Role of this survey: primary (actual), reference (planned/baseline), or comparison"
    )

    # NEW: Reference relationship
    reference_for_survey = models.ForeignKey(
        'self',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='reference_surveys',
        help_text="Primary survey this is a reference for (if survey_role='reference')"
    )

    class Meta:
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['run', 'survey_role']),
            models.Index(fields=['reference_for_survey']),
        ]
```

### Migration File

**File Location:** `apps/api/survey_api/migrations/0011_add_survey_role.py`

```python
from django.db import migrations, models
import django.db.models.deletion

class Migration(migrations.Migration):
    dependencies = [
        ('survey_api', '0010_interpolatedsurvey'),
    ]

    operations = [
        migrations.AddField(
            model_name='surveyfile',
            name='survey_role',
            field=models.CharField(
                choices=[
                    ('primary', 'Primary Survey'),
                    ('reference', 'Reference Survey'),
                    ('comparison', 'Comparison Survey')
                ],
                default='primary',
                max_length=20,
                help_text='Role of this survey'
            ),
        ),
        migrations.AddField(
            model_name='surveyfile',
            name='reference_for_survey',
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.SET_NULL,
                related_name='reference_surveys',
                to='survey_api.surveyfile'
            ),
        ),
        migrations.AddIndex(
            model_name='surveyfile',
            index=models.Index(fields=['run', 'survey_role'], name='survey_file_run_role_idx'),
        ),
        migrations.AddIndex(
            model_name='surveyfile',
            index=models.Index(fields=['reference_for_survey'], name='survey_file_ref_for_idx'),
        ),
    ]
```

### Reference Upload API

**File Location:** `apps/api/survey_api/views/reference_upload_viewset.py`

```python
from rest_framework.decorators import api_view, permission_classes
from rest_framework.permissions import IsAuthenticated
from rest_framework.response import Response
from rest_framework import status

@api_view(['POST'])
@permission_classes([IsAuthenticated])
def upload_reference_survey(request):
    """
    Upload a reference survey file for comparison.

    Applies current run's location, depth, and tie-on context.
    Automatically triggers calculation and interpolation at resolution=10.
    """
    try:
        # Extract parameters
        file = request.FILES.get('file')
        run_id = request.data.get('run_id')
        primary_survey_id = request.data.get('primary_survey_id')  # Optional
        survey_type = request.data.get('survey_type')

        # Validate
        if not file:
            return Response({'error': 'No file provided'}, status=status.HTTP_400_BAD_REQUEST)
        if not run_id:
            return Response({'error': 'run_id is required'}, status=status.HTTP_400_BAD_REQUEST)
        if not survey_type:
            return Response({'error': 'survey_type is required'}, status=status.HTTP_400_BAD_REQUEST)

        # Get run
        run = Run.objects.get(id=run_id)

        # Get primary survey if provided
        primary_survey = None
        if primary_survey_id:
            primary_survey = SurveyFile.objects.get(id=primary_survey_id, run=run)

        # Create SurveyFile
        survey_file = SurveyFile.objects.create(
            run=run,
            file=file,
            filename=file.name,
            file_size=file.size,
            survey_type=survey_type,
            survey_role='reference',  # KEY: Mark as reference
            reference_for_survey=primary_survey,
            processing_status='pending'
        )

        # Parse file (triggers calculation via signal)
        from survey_api.services.file_parser_service import FileParserService
        survey_data = FileParserService.parse_and_create(survey_file)

        return Response({
            'message': 'Reference survey uploaded successfully',
            'survey_file_id': str(survey_file.id),
            'survey_data_id': str(survey_data.id),
            'processing_status': 'processing',
            'survey_role': 'reference'
        }, status=status.HTTP_201_CREATED)

    except Run.DoesNotExist:
        return Response({'error': 'Run not found'}, status=status.HTTP_404_NOT_FOUND)
    except SurveyFile.DoesNotExist:
        return Response({'error': 'Primary survey not found'}, status=status.HTTP_404_NOT_FOUND)
    except Exception as e:
        logger.error(f"Reference survey upload failed: {str(e)}")
        return Response({'error': str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)
```

### Reference Calculation Service Updates

**File Location:** `apps/api/survey_api/services/survey_calculation_service.py`

```python
# In trigger_calculation signal handler
@receiver(post_save, sender=SurveyData)
def trigger_calculation(sender, instance, created, **kwargs):
    """Automatically trigger calculation after SurveyData is created."""
    if created:
        from survey_api.services.survey_calculation_service import SurveyCalculationService
        try:
            calculated_survey = SurveyCalculationService.calculate(str(instance.id))

            # KEY: For reference surveys, use resolution=10 instead of 5
            if instance.survey_file.survey_role == 'reference':
                from survey_api.services.interpolation_service import InterpolationService
                InterpolationService.interpolate(
                    calculated_survey_id=str(calculated_survey.id),
                    resolution=10  # Higher resolution for reference surveys
                )
            else:
                # Primary surveys use resolution=5
                from survey_api.services.interpolation_service import InterpolationService
                InterpolationService.interpolate(
                    calculated_survey_id=str(calculated_survey.id),
                    resolution=5
                )
        except Exception as e:
            logger.error(f"Auto-calculation failed: {str(e)}")
```

### Reference List API

**File Location:** `apps/api/survey_api/views/reference_list_viewset.py`

```python
@api_view(['GET'])
@permission_classes([IsAuthenticated])
def list_reference_surveys(request):
    """List all reference surveys for a run."""
    run_id = request.query_params.get('run_id')
    primary_survey_id = request.query_params.get('primary_survey_id')

    if not run_id:
        return Response({'error': 'run_id is required'}, status=status.HTTP_400_BAD_REQUEST)

    try:
        # Base query
        references = SurveyFile.objects.filter(
            run_id=run_id,
            survey_role='reference'
        ).select_related('survey_data', 'survey_data__calculated_survey')

        # Optional filter by primary survey
        if primary_survey_id:
            references = references.filter(reference_for_survey_id=primary_survey_id)

        # Serialize
        serializer = ReferenceSurveySerializer(references, many=True)

        return Response({
            'count': references.count(),
            'results': serializer.data
        }, status=status.HTTP_200_OK)

    except Exception as e:
        logger.error(f"Failed to list reference surveys: {str(e)}")
        return Response({'error': str(e)}, status=status.HTTP_500_INTERNAL_SERVER_ERROR)
```

### Frontend - Reference Upload Dropdown

**File Location:** `apps/web/src/components/survey/ReferenceUploadDropdown.tsx`

```typescript
import React, { useState } from 'react';
import {
  Box,
  Button,
  Menu,
  MenuItem,
  Typography,
  Chip,
  Divider
} from '@mui/material';
import UploadIcon from '@mui/icons-material/Upload';
import CheckCircleIcon from '@mui/icons-material/CheckCircle';
import { useReferenceSelection } from '../../hooks/useReferenceSelection';

interface ReferenceUploadDropdownProps {
  runId: string;
  onSelectReference: (referenceId: string) => void;
  onUploadNew: () => void;
}

export const ReferenceUploadDropdown: React.FC<ReferenceUploadDropdownProps> = ({
  runId,
  onSelectReference,
  onUploadNew
}) => {
  const [anchorEl, setAnchorEl] = useState<null | HTMLElement>(null);
  const { references, isLoading } = useReferenceSelection(runId);

  const handleClick = (event: React.MouseEvent<HTMLElement>) => {
    setAnchorEl(event.currentTarget);
  };

  const handleClose = () => {
    setAnchorEl(null);
  };

  const handleSelectReference = (referenceId: string) => {
    onSelectReference(referenceId);
    handleClose();
  };

  return (
    <>
      <Button
        variant="outlined"
        startIcon={<UploadIcon />}
        onClick={handleClick}
      >
        Select Reference Survey
      </Button>

      <Menu
        anchorEl={anchorEl}
        open={Boolean(anchorEl)}
        onClose={handleClose}
        PaperProps={{
          style: { maxHeight: 400, width: '350px' }
        }}
      >
        {/* Upload New Option */}
        <MenuItem onClick={() => { handleClose(); onUploadNew(); }}>
          <UploadIcon sx={{ mr: 2 }} />
          <Typography variant="body2" fontWeight="medium">
            Upload New Reference Survey
          </Typography>
        </MenuItem>

        <Divider />

        {/* Previously Uploaded References */}
        {isLoading ? (
          <MenuItem disabled>
            <Typography variant="body2">Loading references...</Typography>
          </MenuItem>
        ) : references.length === 0 ? (
          <MenuItem disabled>
            <Typography variant="body2" color="text.secondary">
              No reference surveys uploaded yet
            </Typography>
          </MenuItem>
        ) : (
          references.map((ref) => (
            <MenuItem
              key={ref.id}
              onClick={() => handleSelectReference(ref.id)}
            >
              <Box sx={{ width: '100%' }}>
                <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                  <Typography variant="body2" fontWeight="medium">
                    {ref.filename}
                  </Typography>
                  {ref.processing_status === 'completed' && (
                    <CheckCircleIcon color="success" fontSize="small" />
                  )}
                </Box>
                <Box sx={{ display: 'flex', gap: 1, mt: 0.5 }}>
                  <Chip label={ref.survey_type} size="small" variant="outlined" />
                  <Chip
                    label={`${ref.calculated_survey?.point_count || 0} points`}
                    size="small"
                  />
                </Box>
                <Typography variant="caption" color="text.secondary">
                  {new Date(ref.upload_date).toLocaleDateString()}
                </Typography>
              </Box>
            </MenuItem>
          ))
        )}
      </Menu>
    </>
  );
};
```

### URL Configuration

**Add to `apps/api/survey_api/urls.py`:**
```python
from survey_api.views.reference_upload_viewset import upload_reference_survey
from survey_api.views.reference_list_viewset import list_reference_surveys, get_reference_survey_detail

urlpatterns = [
    # ... existing URLs ...

    # Reference Survey URLs
    path("api/v1/surveys/reference/upload/", upload_reference_survey, name="upload_reference_survey"),
    path("api/v1/surveys/reference/", list_reference_surveys, name="list_reference_surveys"),
    path("api/v1/surveys/reference/<uuid:id>/", get_reference_survey_detail, name="get_reference_survey_detail"),
]
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-15 | 1.0 | Initial story creation for Epic 5 | Claude (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Completion Notes
- Database model already includes survey_role and reference_for_survey fields (migration 0012)
- Reference upload API fully implemented in reference_viewset.py
- Serializers created: SurveyFileSerializer and ReferenceSurveySerializer
- All URLs registered in urls.py
- Automatic processing triggered via FileParserService

### File List
- apps/api/survey_api/models/survey_file.py (model with survey_role and reference fields)
- apps/api/survey_api/migrations/0012_add_survey_role_and_reference.py (migration)
- apps/api/survey_api/views/reference_viewset.py (upload, list, detail endpoints)
- apps/api/survey_api/serializers/survey_file_serializer.py (serializers)
- apps/api/survey_api/urls.py (URL configuration)

## QA Results
_To be filled by QA agent_
