# Story 5.6: Comparison Frontend Workflow

## Status
Ready for Development

## Story
**As a** survey engineer,
**I want** a streamlined frontend experience for comparing surveys,
**so that** I can quickly set up comparisons and view results

## Acceptance Criteria
1. **Comparison Page** - Create dedicated comparison page/modal
2. **Survey Selection UI** - Dropdowns for primary and reference surveys
3. **Reference Upload Modal** - Modal for uploading new reference
4. **Automatic Processing Indicator** - Show when reference is being calculated
5. **Ratio Factor Control** - Input/slider for ratio factor (1-100, default=10)
6. **Compare Button** - Trigger comparison calculation
7. **Comparison Status** - Show status: preparing → calculating → complete
8. **Results Display** - Statistical summary, 3D plot, 2D plots, delta chart
9. **Survey Switcher** - Swap reference and comparison roles
10. **Previous Comparisons List** - Show history for current run
11. **Comparison Actions** - Download, delete, duplicate
12. **Error Display** - Clear error messages
13. **Loading States** - Loading indicators throughout
14. **Responsive Design** - Mobile-friendly interface
15. **Unit Tests** - Test workflow, UI interactions, error handling (>80% coverage)
16. **Integration Tests** - Test complete workflow end-to-end

## Tasks / Subtasks

- [ ] **Task 1: Create Comparison Page** (AC: 1)
  - [ ] Create `ComparisonPage.tsx`
  - [ ] Add route: `/runs/:runId/compare`
  - [ ] Create page layout with sections:
    - Survey selection
    - Comparison controls
    - Results display
  - [ ] Add breadcrumb navigation

- [ ] **Task 2: Survey Selection UI** (AC: 2, 3)
  - [ ] Create `SurveySelector.tsx`
  - [ ] Primary survey dropdown (list all surveys in run)
  - [ ] Reference survey dropdown:
    - List previously uploaded references
    - "Upload New Reference" option
  - [ ] Integrate `ReferenceUploadModal` from Story 5.1

- [ ] **Task 3: Comparison Controls** (AC: 5, 6)
  - [ ] Create `ComparisonControls.tsx`
  - [ ] Ratio factor slider (1-100)
  - [ ] Show current ratio value
  - [ ] "Compare" button
  - [ ] Validation before comparison

- [ ] **Task 4: Comparison Status Tracking** (AC: 4, 7)
  - [ ] Create `ComparisonStatus.tsx`
  - [ ] Show status stages:
    - Validating surveys
    - Aligning MD stations
    - Calculating deltas
    - Computing statistics
    - Complete
  - [ ] Show progress bar
  - [ ] Poll comparison status

- [ ] **Task 5: Results Display** (AC: 8)
  - [ ] Create `ComparisonResults.tsx`
  - [ ] Statistical summary cards:
    - Max deviation (horizontal, total)
    - Average deviation
    - MD at max deviation
  - [ ] Integrate ComparisonPlot3D
  - [ ] Integrate 2D comparison plots
  - [ ] Integrate DeltaVsMDPlot
  - [ ] Tab-based plot navigation

- [ ] **Task 6: Survey Switcher** (AC: 9)
  - [ ] Add "Swap Surveys" button
  - [ ] Swap primary and reference
  - [ ] Re-run comparison
  - [ ] Show feedback

- [ ] **Task 7: Comparison History** (AC: 10)
  - [ ] Create `ComparisonHistoryList.tsx`
  - [ ] List all comparisons for run
  - [ ] Show: date, surveys, ratio factor, max deviation
  - [ ] Click to load comparison
  - [ ] Paginate list

- [ ] **Task 8: Comparison Actions** (AC: 11)
  - [ ] Download button (integrate Story 5.5)
  - [ ] Delete button with confirmation
  - [ ] Duplicate button (copy with new ratio factor)
  - [ ] Share button (copy URL)

- [ ] **Task 9: Error Handling** (AC: 12)
  - [ ] Show validation errors
  - [ ] Show calculation errors
  - [ ] Show network errors
  - [ ] Add retry button

- [ ] **Task 10: Loading States** (AC: 13)
  - [ ] Skeleton loaders for plots
  - [ ] Loading spinners for API calls
  - [ ] Progress indicators

- [ ] **Task 11: Responsive Design** (AC: 14)
  - [ ] Adapt layout for mobile
  - [ ] Stack plots vertically
  - [ ] Collapsible sections
  - [ ] Touch-friendly controls

- [ ] **Task 12: State Management** (AC: 1-11)
  - [ ] Create `useComparison.ts` hook
  - [ ] Create `useComparisonHistory.ts` hook
  - [ ] Integrate React Query
  - [ ] Cache comparison results

- [ ] **Task 13: Unit Tests** (AC: 15)
  - [ ] Test survey selection
  - [ ] Test comparison creation
  - [ ] Test results display
  - [ ] Test error scenarios

- [ ] **Task 14: Integration Tests** (AC: 16)
  - [ ] Test complete workflow:
    - Upload reference
    - Select surveys
    - Create comparison
    - View results
    - Download results
  - [ ] Test with Playwright/Cypress

## Dev Notes

### Comparison Page Structure

```typescript
export const ComparisonPage: React.FC = () => {
  const { runId } = useParams();
  const [primarySurveyId, setPrimarySurveyId] = useState<string | null>(null);
  const [referenceSurveyId, setReferenceSurveyId] = useState<string | null>(null);
  const [ratioFactor, setRatioFactor] = useState(10);
  const [comparisonId, setComparisonId] = useState<string | null>(null);

  const { createComparison, isCreating } = useCreateComparison();
  const { comparison, isLoading } = useComparison(comparisonId);

  const handleCompare = async () => {
    if (!primarySurveyId || !referenceSurveyId) return;

    const result = await createComparison({
      runId,
      primarySurveyId,
      referenceSurveyId,
      ratioFactor
    });

    setComparisonId(result.id);
  };

  return (
    <Container maxWidth="xl">
      <PageHeader
        title="Survey Comparison"
        breadcrumbs={[
          { label: 'Runs', path: '/runs' },
          { label: `Run ${runId}`, path: `/runs/${runId}` },
          { label: 'Compare' }
        ]}
      />

      <Grid container spacing={3}>
        {/* Left: Selection & Controls */}
        <Grid item xs={12} md={4}>
          <Paper sx={{ p: 3 }}>
            <SurveySelector
              runId={runId}
              primarySurveyId={primarySurveyId}
              referenceSurveyId={referenceSurveyId}
              onPrimaryChange={setPrimarySurveyId}
              onReferenceChange={setReferenceSurveyId}
            />

            <Divider sx={{ my: 3 }} />

            <ComparisonControls
              ratioFactor={ratioFactor}
              onRatioChange={setRatioFactor}
              onCompare={handleCompare}
              disabled={!primarySurveyId || !referenceSurveyId || isCreating}
            />
          </Paper>

          <Paper sx={{ p: 3, mt: 3 }}>
            <Typography variant="h6" gutterBottom>
              Comparison History
            </Typography>
            <ComparisonHistoryList
              runId={runId}
              onSelect={setComparisonId}
            />
          </Paper>
        </Grid>

        {/* Right: Results */}
        <Grid item xs={12} md={8}>
          {isCreating && <ComparisonStatus />}

          {comparison && (
            <ComparisonResults
              comparison={comparison}
              ratioFactor={ratioFactor}
              onRatioChange={setRatioFactor}
            />
          )}

          {!comparison && !isCreating && (
            <Paper sx={{ p: 6, textAlign: 'center' }}>
              <Typography color="text.secondary">
                Select surveys and click "Compare" to see results
              </Typography>
            </Paper>
          )}
        </Grid>
      </Grid>
    </Container>
  );
};
```

### React Query Hooks

```typescript
export const useCreateComparison = () => {
  const queryClient = useQueryClient();

  const mutation = useMutation({
    mutationFn: async (params: CreateComparisonParams) => {
      return await surveyApi.createComparison(params);
    },
    onSuccess: (data, variables) => {
      queryClient.invalidateQueries(['comparisons', variables.runId]);
    }
  });

  return {
    createComparison: mutation.mutateAsync,
    isCreating: mutation.isPending,
    error: mutation.error
  };
};

export const useComparison = (comparisonId: string | null) => {
  return useQuery({
    queryKey: ['comparison', comparisonId],
    queryFn: () => surveyApi.getComparison(comparisonId!),
    enabled: !!comparisonId,
    staleTime: 5 * 60 * 1000
  });
};

export const useComparisonHistory = (runId: string) => {
  return useQuery({
    queryKey: ['comparisons', runId],
    queryFn: () => surveyApi.listComparisons(runId),
    staleTime: 1 * 60 * 1000
  });
};
```

### URL Configuration

Add route to `App.tsx`:
```typescript
<Route
  path="/runs/:runId/compare"
  element={
    <ProtectedRoute>
      <ComparisonPage />
    </ProtectedRoute>
  }
/>
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-15 | 1.0 | Initial story creation for Epic 5 | Claude (Scrum Master) |

## Dev Agent Record
_To be filled during development_

## QA Results
_To be filled by QA agent_
