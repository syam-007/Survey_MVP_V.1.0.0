# Story 5.4: Comparison Visualization (2D & 3D)

## Status
Ready for Development

## Story
**As a** survey engineer,
**I want** to visualize survey comparisons in 2D and 3D with delta overlays,
**so that** I can visually identify where and how much the surveys deviate

## Acceptance Criteria
1. **3D Comparison Plot** - Display both surveys in 3D with delta vectors
2. **2D Comparison Plots** - Support multiple views (vertical, plan, delta vs MD, inc/azi)
3. **Delta Scaling** - Apply ratio factor to delta visualization
4. **Interactive Controls** - Toggle visibility, adjust ratio factor, zoom to max deviation
5. **Deviation Heatmap** - Color-code by deviation magnitude
6. **Legend** - Clear legend identifying reference vs. comparison
7. **Deviation Annotations** - Label maximum deviation points
8. **Plot Export** - Export plots as PNG
9. **Performance** - Render in < 5 seconds
10. **Responsive Design** - Adapt to screen sizes
11. **Loading States** - Show loading indicators
12. **Error Handling** - Handle missing data gracefully
13. **Unit Tests** - Test plot components, data transformation, interactions

## Tasks / Subtasks

- [ ] **Task 1: Create 3D Comparison Plot Component** (AC: 1, 3, 5)
  - [ ] Create `ComparisonPlot3D.tsx`
  - [ ] Render reference survey (blue line)
  - [ ] Render comparison survey (red line)
  - [ ] Add delta vectors (arrows)
  - [ ] Apply ratio factor scaling
  - [ ] Add deviation color gradient
  - [ ] Add interactive camera controls

- [ ] **Task 2: Create 2D Comparison Plot Components** (AC: 2, 3)
  - [ ] Create `ComparisonPlotVertical.tsx` - TVD vs Horizontal
  - [ ] Create `ComparisonPlotPlan.tsx` - North vs East
  - [ ] Create `DeltaVsMDPlot.tsx` - Delta magnitude vs MD
  - [ ] Create `InclinationComparisonPlot.tsx` - Inc vs MD
  - [ ] Create `AzimuthComparisonPlot.tsx` - Azi vs MD
  - [ ] Apply ratio factor to all plots

- [ ] **Task 3: Implement Interactive Controls** (AC: 4)
  - [ ] Create `ComparisonControls.tsx`
  - [ ] Toggle reference visibility
  - [ ] Toggle comparison visibility
  - [ ] Ratio factor slider (1-100)
  - [ ] Zoom to max deviation button
  - [ ] Reset view button

- [ ] **Task 4: Implement Deviation Heatmap** (AC: 5)
  - [ ] Map deviation values to color scale
  - [ ] Use gradient: green (low) → yellow (medium) → red (high)
  - [ ] Add color scale legend
  - [ ] Apply to 3D plot points

- [ ] **Task 5: Add Legend and Annotations** (AC: 6, 7)
  - [ ] Add survey legend (reference/comparison)
  - [ ] Annotate max deviation point
  - [ ] Show deviation value at max point
  - [ ] Add grid lines and axis labels

- [ ] **Task 6: Implement Plot Export** (AC: 8)
  - [ ] Add export button
  - [ ] Export as PNG using Plotly's download feature
  - [ ] Include timestamp in filename

- [ ] **Task 7: Optimize Performance** (AC: 9)
  - [ ] Downsample large datasets (>5000 points)
  - [ ] Use WebGL rendering for 3D
  - [ ] Lazy load 2D plots
  - [ ] Profile rendering time

- [ ] **Task 8: Add Responsive Design** (AC: 10)
  - [ ] Adapt plot size to container
  - [ ] Stack plots vertically on mobile
  - [ ] Adjust font sizes

- [ ] **Task 9: Add Loading States** (AC: 11)
  - [ ] Show skeleton loaders
  - [ ] Show progress indicators
  - [ ] Handle slow network

- [ ] **Task 10: Error Handling** (AC: 12)
  - [ ] Handle empty data
  - [ ] Handle calculation errors
  - [ ] Show error messages

- [ ] **Task 11: Unit Tests** (AC: 13)
  - [ ] Test plot rendering
  - [ ] Test ratio factor application
  - [ ] Test interactive controls
  - [ ] Test error states

## Dev Notes

### 3D Comparison Plot Component

```typescript
interface ComparisonPlot3DProps {
  comparisonData: ComparisonResult;
  ratioFactor: number;
  showReference: boolean;
  showComparison: boolean;
}

export const ComparisonPlot3D: React.FC<ComparisonPlot3DProps> = ({
  comparisonData,
  ratioFactor,
  showReference,
  showComparison
}) => {
  // Prepare reference trace (blue)
  const referenceTrace = {
    x: comparisonData.reference_survey.easting,
    y: comparisonData.reference_survey.northing,
    z: comparisonData.reference_survey.tvd,
    mode: 'lines',
    type: 'scatter3d',
    name: 'Reference',
    line: { color: 'blue', width: 4 },
    visible: showReference
  };

  // Prepare comparison trace (red)
  const comparisonTrace = {
    x: comparisonData.primary_survey.easting,
    y: comparisonData.primary_survey.northing,
    z: comparisonData.primary_survey.tvd,
    mode: 'lines',
    type: 'scatter3d',
    name: 'Comparison',
    line: { color: 'red', width: 4 },
    visible: showComparison
  };

  // Add delta vectors scaled by ratio factor
  const deltaVectors = createDeltaVectors(comparisonData, ratioFactor);

  return (
    <Plot
      data={[referenceTrace, comparisonTrace, ...deltaVectors]}
      layout={{
        scene: {
          xaxis: { title: 'Easting (m)' },
          yaxis: { title: 'Northing (m)' },
          zaxis: { title: 'TVD (m)', autorange: 'reversed' }
        }
      }}
    />
  );
};
```

### Delta vs MD Plot

```typescript
export const DeltaVsMDPlot: React.FC<{ comparisonData: ComparisonResult }> = ({
  comparisonData
}) => {
  const traces = [
    {
      x: comparisonData.md_data,
      y: comparisonData.delta_horizontal,
      name: 'Horizontal Deviation',
      line: { color: 'orange' }
    },
    {
      x: comparisonData.md_data,
      y: comparisonData.delta_total,
      name: 'Total Deviation',
      line: { color: 'red' }
    }
  ];

  return (
    <Plot
      data={traces}
      layout={{
        xaxis: { title: 'Measured Depth (m)' },
        yaxis: { title: 'Deviation (m)' },
        title: 'Deviation vs Measured Depth'
      }}
    />
  );
};
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-15 | 1.0 | Initial story creation for Epic 5 | Claude (Scrum Master) |

## Dev Agent Record
_To be filled during development_

## QA Results
_To be filled by QA agent_
