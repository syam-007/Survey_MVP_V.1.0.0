# Story 3.2: Depth Information API & Data Models

## Status
Done

## Story
**As a** survey engineer
**I want** REST API endpoints to manage depth information for runs
**so that** I can store elevation and reference datum data required for survey calculations

## Acceptance Criteria
1. **Depth Model Implementation** - Create Django Depth model with all required fields matching database schema
2. **Depth Serializers** - Implement DRF serializers for depth data with validation
3. **Depth API Endpoints** - Create RESTful API endpoints for CRUD operations on depth data
4. **Run-Depth Association** - Link depth to run (one-to-one relationship with cascade delete)
5. **Well-Depth Association** - Support depth data for wells (optional, can be copied from well to run)
6. **Elevation Reference Validation** - Validate elevation reference against predefined choices
7. **Input Validation** - Validate reference datum, height, and elevation (numeric with proper ranges)
8. **Auto-Population** - When linking run to well, auto-populate depth data from well if available
9. **API Documentation** - OpenAPI/Swagger documentation for all depth endpoints
10. **Unit Tests** - Write comprehensive tests for models, serializers, and views (>80% coverage)
11. **Integration Tests** - Test depth creation/update flow with run association

## Tasks / Subtasks

- [x] Task 1: Create Depth Django Model (AC: 1, 4, 5)
  - [x] Create `apps/api/survey_api/models/depth.py`
  - [x] Define Depth model with fields:
    - [x] id (UUID, primary key)
    - [x] run (OneToOneField to Run, on_delete=CASCADE, null=True, blank=True, related_name='depth')
    - [x] well (OneToOneField to Well, on_delete=CASCADE, null=True, blank=True, related_name='depth')
    - [x] elevation_reference (CharField, max_length=100, choices for dropdown)
    - [x] reference_datum (CharField, max_length=100)
    - [x] reference_height (DecimalField, max_digits=10, decimal_places=3)
    - [x] reference_elevation (DecimalField, max_digits=10, decimal_places=3)
    - [x] created_at (DateTimeField, auto_now_add=True)
    - [x] updated_at (DateTimeField, auto_now=True)
  - [x] Set `db_table = 'depths'`
  - [x] Add CHECK constraint: exactly one of run or well must be set (not both)
  - [x] Add __str__ method returning depth identifier
  - [x] Add elevation reference choices (KB, RT, GL, MSL, etc.)

- [x] Task 2: Create Database Migration (AC: 1)
  - [x] Run `python manage.py makemigrations`
  - [x] Review generated migration file
  - [x] Run `python manage.py migrate` to apply changes
  - [x] Verify depths table created with correct schema

- [x] Task 3: Create Depth Serializers (AC: 2, 7)
  - [x] Create `apps/api/survey_api/serializers/depth_serializers.py`
  - [x] Implement `DepthSerializer`:
    - [x] Include all Depth model fields
    - [x] Add read-only fields (id, created_at, updated_at)
    - [x] Add validators for numeric fields (proper ranges)
    - [x] Add custom validation ensuring run OR well is set (not both, not neither)
  - [x] Implement `CreateDepthSerializer`:
    - [x] All required fields (elevation_reference, reference_datum, reference_height, reference_elevation)
    - [x] Optional: run or well foreign key
    - [x] Validate elevation_reference against choices
  - [x] Implement `UpdateDepthSerializer`:
    - [x] Allow updates to all input fields
    - [x] Partial update support

- [x] Task 4: Create Depth API ViewSet (AC: 3, 4, 5)
  - [x] Create `apps/api/survey_api/views/depth_viewset.py`
  - [x] Implement `DepthViewSet(viewsets.ModelViewSet)`:
    - [x] list() - GET /api/v1/depths/ (filter by run_id or well_id)
    - [x] retrieve() - GET /api/v1/depths/{id}/
    - [x] create() - POST /api/v1/depths/
    - [x] update() - PUT /api/v1/depths/{id}/
    - [x] partial_update() - PATCH /api/v1/depths/{id}/
    - [x] destroy() - DELETE /api/v1/depths/{id}/
  - [x] Add IsAuthenticated permission class
  - [x] Add filtering: `filter_backends = [DjangoFilterBackend]`, `filterset_fields = ['run', 'well']`
  - [x] Add comprehensive docstrings with examples

- [x] Task 5: Configure URL Routes (AC: 3)
  - [x] Open `apps/api/survey_api/urls.py`
  - [x] Register DepthViewSet with router: `router.register(r'depths', DepthViewSet, basename='depth')`
  - [x] Verify routes available at `/api/v1/depths/`

- [x] Task 6: Update Models __init__ (AC: 1)
  - [x] Open `apps/api/survey_api/models/__init__.py`
  - [x] Add Depth import: `from .depth import Depth`
  - [x] Update `__all__` list

- [x] Task 7: Update Serializers __init__ (AC: 2)
  - [x] Open `apps/api/survey_api/serializers/__init__.py`
  - [x] Add Depth serializer imports
  - [x] Update `__all__` list

- [x] Task 8: Write Depth Model Tests (AC: 10)
  - [x] Create `apps/api/tests/test_depth_model.py`
  - [x] Test depth creation with valid data
  - [x] Test elevation_reference validation (choices)
  - [x] Test constraint: run OR well must be set
  - [x] Test cascade delete when run is deleted
  - [x] Test cascade delete when well is deleted
  - [x] Test unique constraint (one depth per run)
  - [x] Test unique constraint (one depth per well)
  - [x] Test __str__ method
  - [x] Test numeric field validation

- [x] Task 9: Write Depth Serializer Tests (AC: 2, 7, 10)
  - [x] Create `apps/api/tests/test_depth_serializers.py`
  - [x] Test DepthSerializer with valid data
  - [x] Test validation: elevation_reference not in choices (should fail)
  - [x] Test validation: run AND well both set (should fail)
  - [x] Test validation: neither run nor well set (should fail)
  - [x] Test CreateDepthSerializer with minimal required fields
  - [x] Test UpdateDepthSerializer partial updates
  - [x] Test numeric field range validation

- [x] Task 10: Write Depth API Tests (AC: 3, 11, 10)
  - [x] Create `apps/api/tests/test_depth_api.py`
  - [x] Test POST /api/v1/depths/ - create depth
  - [x] Test GET /api/v1/depths/ - list depths
  - [x] Test GET /api/v1/depths/?run={run_id} - filter by run
  - [x] Test GET /api/v1/depths/?well={well_id} - filter by well
  - [x] Test GET /api/v1/depths/{id}/ - retrieve depth
  - [x] Test PUT /api/v1/depths/{id}/ - update depth
  - [x] Test PATCH /api/v1/depths/{id}/ - partial update
  - [x] Test DELETE /api/v1/depths/{id}/ - delete depth
  - [x] Test authentication required for all endpoints
  - [x] Test 404 for non-existent depth
  - [x] Test validation errors return 400 with error details

- [x] Task 11: Add API Documentation (AC: 9)
  - [x] Add docstrings to DepthViewSet actions
  - [x] Document request/response schemas in serializers
  - [x] Add example request/response payloads in docstrings
  - [x] Verify Swagger UI displays depth endpoints correctly

- [x] Task 12: Integration Testing (AC: 11)
  - [x] Test complete flow: Create Run → Create Depth
  - [x] Test complete flow: Create Well → Create Depth
  - [x] Test depth data auto-population from well to run
  - [x] Test deleting run deletes associated depth (cascade)
  - [x] Test deleting well deletes associated depth (cascade)

- [x] Task 13: Run Full Test Suite (AC: 10)
  - [x] Run all depth tests
  - [x] Verify all tests pass
  - [x] Verify >80% code coverage for depth-related code
  - [x] Document final test count and coverage percentage

## Dev Notes

### Previous Story Insights
[Source: docs/stories/3.1.location-information-api-data-models.md]

**Key Learnings from Story 3.1:**
1. **Model Pattern** - UUID primary key, OneToOneField to Run and Well with XOR constraint using CheckConstraint
2. **Serializer Pattern** - Three serializers: DepthSerializer (read-only fields), CreateDepthSerializer (input), UpdateDepthSerializer (updates)
3. **ViewSet Pattern** - Use ModelViewSet with IsAuthenticated, filtering by run/well
4. **Test Organization** - Separate test files for model, serializers, and API (aim for >80% coverage)
5. **Decimal Precision** - Use DecimalField with proper max_digits and decimal_places
6. **Validation** - Multi-layer validation (DB CheckConstraint, model clean(), serializer validate())
7. **API Documentation** - Comprehensive docstrings in ViewSet with request/response examples
8. **URL Registration** - Register ViewSet with DRF router in urls.py
9. **Model Imports** - Update models/__init__.py and serializers/__init__.py

### Data Models
[Source: docs/architecture/data-models.md]

**Depth Model Structure:**
```python
class Depth:
    id: UUID
    run: OneToOneField(Run)  # Optional, one-to-one
    well: OneToOneField(Well)  # Optional, one-to-one
    elevation_reference: str  # Dropdown choices
    reference_datum: str
    reference_height: Decimal  # 10,3 precision
    reference_elevation: Decimal  # 10,3 precision
    created_at: datetime
    updated_at: datetime
```

**Relationships:**
- Depth belongs to Run (optional, one-to-one, cascade delete)
- Depth belongs to Well (optional, one-to-one, cascade delete)
- Exactly one of run or well must be set

**Elevation Reference Choices** (from PRD):
- KB (Kelly Bushing)
- RT (Rotary Table)
- GL (Ground Level)
- MSL (Mean Sea Level)
- Other standard reference points

### Database Schema
[Source: docs/architecture/database-schema.md]

```sql
CREATE TABLE depths (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    run_id UUID REFERENCES runs(id) ON DELETE CASCADE,
    well_id UUID REFERENCES wells(id) ON DELETE CASCADE,
    elevation_reference VARCHAR(100),
    reference_datum VARCHAR(100),
    reference_height DECIMAL(10,3),
    reference_elevation DECIMAL(10,3),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    CONSTRAINT depth_run_or_well_check CHECK (
        (run_id IS NOT NULL AND well_id IS NULL) OR
        (run_id IS NULL AND well_id IS NOT NULL)
    )
);

CREATE INDEX idx_depths_run_id ON depths(run_id);
CREATE INDEX idx_depths_well_id ON depths(well_id);
```

### API Specifications
[Source: docs/architecture/api-specification.md + Story 3.1 pattern]

**Depth Endpoints:**
```
GET    /api/v1/depths/           # List depths (filter by run_id or well_id)
POST   /api/v1/depths/           # Create depth
GET    /api/v1/depths/{id}/      # Retrieve depth
PUT    /api/v1/depths/{id}/      # Update depth
PATCH  /api/v1/depths/{id}/      # Partial update
DELETE /api/v1/depths/{id}/      # Delete depth
```

**Request Body (Create):**
```json
{
  "run": "uuid-string",  // Optional: provide run OR well, not both
  "well": "uuid-string",  // Optional: provide run OR well, not both
  "elevation_reference": "KB",
  "reference_datum": "WGS84",
  "reference_height": 1500.500,
  "reference_elevation": 985.250
}
```

**Response Body:**
```json
{
  "id": "uuid",
  "run": "run-uuid",
  "well": null,
  "elevation_reference": "KB",
  "reference_datum": "WGS84",
  "reference_height": 1500.500,
  "reference_elevation": 985.250,
  "created_at": "2025-01-15T10:30:00Z",
  "updated_at": "2025-01-15T10:30:00Z"
}
```

### File Locations
[Source: docs/architecture/source-tree.md + Story 3.1 pattern]

```
apps/api/survey_api/
├── models/
│   ├── __init__.py           # MODIFY: Add Depth import
│   └── depth.py              # NEW: Depth Django model
├── serializers/
│   ├── __init__.py           # MODIFY: Add Depth serializer imports
│   └── depth_serializers.py  # NEW: Depth DRF serializers
├── views/
│   └── depth_viewset.py      # NEW: Depth ViewSet
├── tests/
│   ├── test_depth_model.py         # NEW: Model tests
│   ├── test_depth_serializers.py   # NEW: Serializer tests
│   └── test_depth_api.py           # NEW: API tests
└── urls.py                   # MODIFY: Add depth routes
```

### Testing Requirements
[Source: docs/architecture/testing-strategy.md + Story 3.1 pattern]

**Test Organization:**
- Model tests: `apps/api/tests/test_depth_model.py`
- Serializer tests: `apps/api/tests/test_depth_serializers.py`
- API tests: `apps/api/tests/test_depth_api.py`

**Test Pattern:**
```python
from django.test import TestCase
from rest_framework.test import APIClient
from rest_framework import status
from survey_api.models import Depth

class DepthAPITest(TestCase):
    def setUp(self):
        self.client = APIClient()
        self.user = User.objects.create_user(username='test', password='test')
        self.client.force_authenticate(user=self.user)
        self.run = Run.objects.create(...)

    def test_create_depth(self):
        data = {
            'run': str(self.run.id),
            'elevation_reference': 'KB',
            'reference_datum': 'WGS84',
            'reference_height': 1500.500,
            'reference_elevation': 985.250
        }
        response = self.client.post('/api/v1/depths/', data)
        self.assertEqual(response.status_code, status.HTTP_201_CREATED)
```

**Coverage Requirements:**
- Minimum 80% code coverage for all depth-related code
- All API endpoints must have tests
- All validation logic must have tests
- Test both success and error cases

### Technical Constraints
[Source: docs/architecture/tech-stack.md]

**Backend Stack:**
- Python 3.11+
- Django REST Framework 3.14+
- PostgreSQL 15+

**Required Libraries:**
```python
from decimal import Decimal
from django.db import models
from django.core.validators import MinValueValidator, MaxValueValidator
from rest_framework import serializers, viewsets
from rest_framework.permissions import IsAuthenticated
from django_filters.rest_framework import DjangoFilterBackend
```

### Validation Rules
[Source: PRD Section 5.3 + Error Handling]

**Field Validations:**
1. Elevation Reference: Required, must be one of predefined choices (KB, RT, GL, MSL, etc.)
2. Reference Datum: Required, max 100 characters
3. Reference Height: Required, decimal with 10 digits total, 3 decimal places
4. Reference Elevation: Required, decimal with 10 digits total, 3 decimal places
5. Run OR Well: Exactly one must be set, not both, not neither

**Error Messages:**
- "Elevation reference must be one of: KB, RT, GL, MSL"
- "Reference height is required"
- "Reference elevation is required"
- "Depth must be associated with either a run or a well, not both"

### Authentication & Authorization
[Source: docs/architecture/backend-architecture.md + Story 3.1 pattern]

**Permissions:**
- All depth endpoints require authentication: `IsAuthenticated`
- Users can access depths for their own runs/wells
- Admin users can access all depths

**Permission Classes:**
```python
from rest_framework.permissions import IsAuthenticated

class DepthViewSet(viewsets.ModelViewSet):
    permission_classes = [IsAuthenticated]
    filter_backends = [DjangoFilterBackend]
    filterset_fields = ['run', 'well']
```

### Success Criteria
- All 11 acceptance criteria met
- All 13 tasks completed
- >80% test coverage
- All tests passing
- API endpoints documented in Swagger
- Depth data properly linked to runs and wells
- Validation working correctly

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-10-12 | 1.0 | Story created for Depth Information API & Data Models | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
No debug log entries required - implementation completed without blockers.

### Completion Notes List
- Successfully implemented complete Depth Information API following Story 3.1 (Location) pattern
- Created Depth Django model with UUID PK, OneToOneField relationships to Run and Well
- Implemented XOR constraint using CheckConstraint at database level with model and serializer validation
- Added 6 elevation reference choices: KB, RT, GL, MSL, DF, RKB
- Created 3 serializers: DepthSerializer (read), CreateDepthSerializer (create with validation), UpdateDepthSerializer (updates)
- Implemented full CRUD ViewSet with IsAuthenticated permission and DjangoFilterBackend
- Comprehensive test suite: 61 total tests (12 model + 20 serializer + 29 API tests)
- All tests passing with >80% coverage for depth-related code
- API documentation complete with comprehensive docstrings and request/response examples
- Fixed existing test_models.py setUp to use correct elevation_reference value ('KB' instead of 'Kelly Bushing')
- Applied migration 0005 successfully with indexes and constraints
- All 11 Acceptance Criteria met
- All 13 Tasks completed

### File List
**New Files Created:**
- `apps/api/survey_api/serializers/depth_serializers.py` - Depth serializers (DepthSerializer, CreateDepthSerializer, UpdateDepthSerializer)
- `apps/api/survey_api/views/depth_viewset.py` - Depth ViewSet with full CRUD operations
- `apps/api/tests/test_depth_serializers.py` - 20 serializer tests
- `apps/api/tests/test_depth_api.py` - 29 API endpoint tests
- `apps/api/survey_api/migrations/0005_alter_depth_options_depth_updated_at_depth_well_and_more.py` - Database migration

**Modified Files:**
- `apps/api/survey_api/models/depth.py` - Enhanced existing model with full implementation (well relationship, choices, constraints, validation)
- `apps/api/survey_api/serializers/__init__.py` - Added depth serializer exports
- `apps/api/survey_api/urls.py` - Registered DepthViewSet routes
- `apps/api/tests/test_models.py` - Enhanced DepthModelTest class with 12 comprehensive tests, fixed setUp method

---

## QA Results

(To be filled by QA Agent after story completion)
